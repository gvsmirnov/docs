<!doctype html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="utf-8" />

    <title>Mutation Analysis Or What Code Coverage Doesn't Tell Us</title>

    <link href="css/impress.css" rel="stylesheet"/>
    <link href="css/prettify.css" rel="stylesheet"/>
    <link href="css/animation.css" rel="stylesheet"/>
    <link href="css/bootstrap.min.css" rel="stylesheet"/>
    <link href="css/fonts.css" rel="stylesheet"/>

    <script src="js/jquery.min.js"></script>
    <script src="js/jmpress.impress.js"></script>
    <script src="js/google-code-prettify/prettify.js"></script>
    <script src="js/bootstrap.min.js"></script>

</head>
<body>

    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand">
                    JUC Israel 2014
                </a>

                <p class="navbar-text">
                    Mutation Analysis: What Code Coverage Doesn't Tell Us
                    <span class="text-muted">by</span> <span class="text-info">@gvsmirnov</span>
                </p>


            </div>
            <div class="navbar-right">
                <a class="navbar-brand">
                    Step <span id="current-slide-number">#</span>/<span id="total-slides">#</span>
                </a>
            </div>
        </div>
    </nav>

    <div id="laser"></div>

    <div id="impress">

        <div class="step step-title" data-y="-800">
            <div class="jumbotron text-center">
                <h1>
                    Mutation Analysis:<br/>
                </h1>

                <h2>
                    What Code Coverage
                    Doesn't Tell Us
                </h2>

                <footer>
                    <h2>#pitest #juc2014</h2>
                    <h2>Gleb Smirnov</h2>
                    <h3>me<span class="text-info">@gvsmirnov</span>.ru</h3>
                </footer>

            </div>
        </div>

        <!-- CODE COVERAGE SUCKS -->

        <div class="step step-slide">
            <h1>Sometimes, The Tests Suck</h1>

<pre class="prettyprint lang-java" data-jmpress="fade">
public class SampleSmallClassTest {

    @Test
    public void testStuff() {
        // The boss says we should write tests.
        // Doesn't seem that hard...

        assertTrue(true);
    }

}
</pre>
        </div>

        <div class="step step-slide" data-x="1300">
            <h1>So We Use Code Coverage</h1>

<pre class="prettyprint console lang-bash" data-jmpress="fade">
$ gradle test --tests *testStuff jacocoTestReport
</pre>
            <div class="well well-lg" data-jmpress="fade">

            <table class="table table-big-text">
                <thead>
                <tr>
                    <td>Element</td>
                    <td>Missed Instructions</td>
                    <td>Coverage</td>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>doSomeMath(int, int)</td>
                    <td>
                        <div class="progress">
                            <div class="progress-bar progress-bar-danger" style="width: 100%"></div>
                        </div>
                    </td>
                    <td>0%</td>
                </tr>
                </tbody>
            </table>

            </div>
        </div>

        <div class="step step-slide spoiler" data-x="1300">
            <h1>&nbsp;</h1>
            <div class="row well">
                <div class="col-md-4">
                    <img class="img-responsive img-rounded" src="img/PHP_CEO.JPG"/>
                </div>
                <div class="col-md-8">
                    <h1><strong>@PHP_CEO</strong></h1>
                    <h2>
                        <strong>
                            YOU GET THAT CODE COVERAGE TO 100%...<br/>
                            OR YOU'RE FIRED !! !!!!
                        </strong>
                    </h2>
                </div>
            </div>
        </div>

        <div class="step step-slide" data-x="2600">
            <h1>It Makes Us Write Better Tests</h1>

<pre class="prettyprint lang-java" data-jmpress="fade">
@Test
public void testStuffWithCoverage() {
    // Need to get that coverage thing high...

    for(int a = -5; a <= 5; a ++) {
        for (int b = -5; b <= 5; b++) {
            SampleSmallClass.doSomeMath(a, b);
        }
    }
}
</pre>
        </div>

        <div class="step step-slide" data-x="3900">
            <h1>Which Give Better Metrics</h1>

<pre class="prettyprint console lang-bash" data-jmpress="fade">
$ gradle test --tests *testStuffWithCoverage jacocoTestReport
</pre>

            <div class="well well-lg" data-jmpress="fade">

                <table class="table table-big-text">
                    <thead>
                    <tr>
                        <td>Element</td>
                        <td>Missed Instructions</td>
                        <td>Coverage</td>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>doSomeMath(int, int)</td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar progress-bar-success" style="width: 100%"></div>
                            </div>
                        </td>
                        <td>100%</td>
                    </tr>
                    </tbody>
                </table>

            </div>

        </div>

        <div class="step step-slide spoiler" data-x="3900">
            <div class="jumbotron text-center">
                <h1 class="margin-a-lot"><span class="text-giant">
                    But Still Suck
                </span></h1>
            </div>
        </div>

        <!-- CODE COVERAGE SUCKS END -->

        <!-- MUTATION ANALYSIS IN A NUTSHELL -->

        <div class="step step-slide" data-y="800">
            <h1>We Can Do Better Than That</h1>
            <ol>
                <li data-jmpress="fade">Run the tests</li>
                <li data-jmpress="fade">Mess with the code</li>
                <li data-jmpress="fade">Run the tests again</li>
                <li data-jmpress="fade" class="list-unstyled">
                    If tests start failing, then the change is
                    <span class="covered">covered</span>
                </li>
                <li data-jmpress="fade" class="list-unstyled">
                    If no test start failing, the change is
                    <span class="not-covered">not covered</span>
                </li>
            </ol>
        </div>

        <div class="step step-slide" data-y="800" data-x="1300">
            <!-- TODO: represent as a timeline -->
            <h1>The Idea Is Not New At All</h1>
            <ul class="list-unstyled">
                <li data-jmpress="fade">
                    1971: Richard Lipton suggests <strong>Mutation Analysis</strong>
                </li>
                <li data-jmpress="fade">
                    1979: Timothy Budd implements the first FORTRAN framework
                </li>
                <li data-jmpress="fade">
                    &nbsp;&CenterDot;&CenterDot;&CenterDot;
                </li>
                <li data-jmpress="fade">
                    2000: Jester &dash; the JUnit test tester
                </li>
                <li data-jmpress="fade">
                    &nbsp;&CenterDot;&CenterDot;&CenterDot;
                </li>
                <li data-jmpress="fade">
                    &nbsp;&CenterDot;&CenterDot;&CenterDot;
                </li>
            </ul>
        </div>

        <div class="step step-slide spoiler" data-y="800" data-x="1300">
            <div class="text-center jumbotron text-v-center">
                <img class="graph" src="img/tumbleweed.gif"/>
            </div>
        </div>

        <div class="step step-slide" data-y="800" data-x="2600">
            <h1>We Need Automated Tools</h1>
            <ul>
                <li data-jmpress="fade">Shouldn't take forever to run</li>
                <li data-jmpress="fade">Should be easy to integrate with existing code</li>
                <li data-jmpress="fade">Should support latest versions of stuff</li>
                <li data-jmpress="fade">Shouldn't be abandoned</li>
            </ul>
        </div>

        <div class="step step-slide" data-y="800" data-x="3900">
            <h1>A Fancy Table</h1>
            <table class="table table-big-text text-center">
                <thead>
                    <tr>
                        <th>Tool</th>
                        <th>Ant</th>
                        <th>Maven</th>
                        <th>Gradle</th>
                        <th>Java</th>
                        <th>TestNG</th>
                        <th>*Mock*</th>
                        <th>Last Update</th>
                    </tr>
                </thead>
                <tbody>

                    <tr data-jmpress="fade">
                        <td style="text-align: left">Simple Jester</td> <!-- Tool -->
                        <td class="danger">N</td> <!-- Ant -->
                        <td class="danger">N</td> <!-- Maven -->
                        <td class="danger">N</td> <!-- Gradle -->
                        <td class="danger">5-6</td> <!-- Java -->
                        <td class="danger">N</td> <!-- TestNG -->
                        <td>?</td> <!-- *Mock* -->
                        <td class="danger">2009</td> <!-- Last Update -->
                    </tr>

                    <tr data-jmpress="fade">
                        <td style="text-align: left">javaLanche</td> <!-- Tool -->
                        <td class="danger">N</td> <!-- Ant -->
                        <td class="danger">N</td> <!-- Maven -->
                        <td class="danger">N</td> <!-- Gradle -->
                        <td class="danger">5-6</td> <!-- Java -->
                        <td class="danger">N</td> <!-- TestNG -->
                        <td>?</td> <!-- *Mock* -->
                        <td class="danger">2011</td> <!-- Last Update -->
                    </tr>

                    <tr data-jmpress="fade">
                        <td style="text-align: left">Jumble</td> <!-- Tool -->
                        <td class="success">Y</td> <!-- Ant -->
                        <td class="danger">N</td> <!-- Maven -->
                        <td class="danger">N</td> <!-- Gradle -->
                        <td class="danger">4-6</td> <!-- Java -->
                        <td class="success">Y</td> <!-- TestNG -->
                        <td class="info">3/6</td> <!-- *Mock* -->
                        <td class="warning">2013</td> <!-- Last Update -->
                    </tr>

                    <tr data-jmpress="fade">
                        <td style="text-align: left">Pitest</td> <!-- Tool -->
                        <td class="success">Y</td> <!-- Ant -->
                        <td class="success">Y</td> <!-- Maven -->
                        <td class="success">Y</td> <!-- Gradle -->
                        <td class="success">5-8</td> <!-- Java -->
                        <td class="success">Y</td> <!-- TestNG -->
                        <td class="success">6/6</td> <!-- *Mock* -->
                        <td class="success">Yesterday</td> <!-- Last Update -->
                    </tr>
                </tbody>
            </table>

            <footer>
                <p class="text-bigger text-muted">
                    <br/>
                    * Powermock, JMock, JMock2, Mockito, JMockit, EasyMock
                </p>
            </footer>
        </div>

        <div class="step step-slide spoiler" data-y="800" data-x="3900">
            <div class="jumbotron text-center">
                <h1 class="margin-a-lot"><span class="text-giant text-success">
                    Yay Pitest!
                </span></h1>
            </div>
        </div>

        <div class="step step-slide" data-y="800" data-x="5200">
            <h1>Let's Check It Out!</h1>

<pre class="prettyprint console lang-bash" data-jmpress="fade">
$ gradle test --tests *testStuffWithCoverage pitest
</pre>
            <div class="well well-lg" data-jmpress="fade">

                <table class="table table-big-text">
                    <thead>
                    <tr>
                        <td>Name</td>
                        <td>Line Coverage</td>
                        <td>Mutation Coverage</td>
                    </tr>
                    </thead>
                    <tfoot>
                    <tr>
                        <td>Total</td>
                        <td>100%</td>
                        <td>0%</td>
                    </tr>
                    </tfoot>
                    <tbody>
                    <tr>
                        <td>SampleSmallClass.java	</td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar progress-bar-success" style="width: 100%"></div>
                            </div>
                        </td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar progress-bar-danger" style="width: 100%"></div>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>

            </div>
        </div>

        <div class="step step-slide" data-y="1600" data-x="5200">
            <h1>Some Very Advanced Business Logic</h1>
<pre class="prettyprint lang-java">
public static int doSomeMath(int a, int b) {
    long result = b;

    result += a;
    result -= b;
    result -= a;

    return (int) result;
}
</pre>
        </div>

        <div class="step step-slide" data-y="2400" data-x="5200">
            <h1>Pit Has Messed With Your Code (1)</h1>
<pre class="prettyprint lang-java">
public static int doSomeMath(int a, int b) {
    long result = b;

    result <span class="attention-here">-=</span> a;
    result -= b;
    result -= a;

    return (int) result;
}
</pre>
            <div data-jmpress="fade">
                <p class="not-covered">
                    Replaced long addition with subtraction → SURVIVED
                </p>
            </div>
        </div>

        <div class="step step-slide" data-y="3200" data-x="5200">
            <h1>Pit Has Messed With Your Code (2)</h1>
<pre class="prettyprint lang-java">
public static int doSomeMath(int a, int b) {
    long result = b;

    result += a;
    result -= b;
    result <span class="attention-here">+=</span> a;

    return (int) result;
}
</pre>

            <div data-jmpress="fade">
                <p class="not-covered">
                    Replaced long subtraction with addition → SURVIVED
                </p>
            </div>
        </div>

        <div class="step step-slide" data-y="4000" data-x="5200">
            <h1>Pit Has Messed With Your Code (3)</h1>
<pre class="prettyprint lang-java">
public static int doSomeMath(int a, int b) {
    long result = b;

    result += a;
    result -= b;
    result -= a;

    return <span class="attention-here">((int) result == 0 ? 1 : 0)</span>;
}
</pre>

            <div data-jmpress="fade">
                <p class="not-covered">
                    Replaced return value with (x == 0 ? 1 : 0) → SURVIVED
                </p>
            </div>
        </div>

        <div class="step step-slide" data-y="800" data-x="6500">
            <h1>So We Need To Assert Something</h1>

<pre class="prettyprint lang-java" data-jmpress="fade">
@Test
public void testProperly() {
    final int expected = 0;

    for(int a = -5; a <= 5; a ++) {
        for(int b = -5; b <= 5; b ++) {
            <span class="attention-here">assertEquals</span>(expected, doSomeMath(a, b));
        }
    }
}
</pre>
        </div>

        <div class="step step-slide" data-y="800" data-x="7800">
            <h1>The Test Seems Fine Now</h1>

<pre class="prettyprint console lang-bash" data-jmpress="fade">
$ gradle test --tests *testProperly pitest
</pre>
            <div class="well well-lg" data-jmpress="fade">

                <table class="table table-big-text">
                    <thead>
                    <tr>
                        <td>Name</td>
                        <td>Line Coverage</td>
                        <td>Mutation Coverage</td>
                    </tr>
                    </thead>
                    <tfoot>
                    <tr>
                        <td>Total</td>
                        <td>100%</td>
                        <td>100%</td>
                    </tr>
                    </tfoot>
                    <tbody>
                    <tr>
                        <td>SampleSmallClass.java	</td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar progress-bar-success" style="width: 100%"></div>
                            </div>
                        </td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar progress-bar-success" style="width: 100%"></div>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>

            </div>
        </div>

        <!-- MUTATION ANALYSIS IN A NUTSHELL ENDS -->

        <!-- PITEST DETAILS -->

        <div class="step step-slide" data-y="1600">
            <h1>The Ultimate Guide To Mutation Analysis</h1>
            <ol>
                <li data-jmpress="fade">Pick classes to mutate</li>
                <li data-jmpress="fade">Mutate the chosen classes</li>
                <li data-jmpress="fade">Run the tests against the mutants</li>
            </ol>
        </div>

        <div class="step step-slide" data-y="1600" data-x="1300">
            <h1>Picking Mutation Targets</h1>
            <ol>
                <li data-jmpress="fade">Compile the sources to <strong>bytecode</strong></li>
                <li data-jmpress="fade">Run selected tests</li>
                <li data-jmpress="fade">
                    Remember which instructions are <strong>executed</strong>
                    by which tests
                </li>
            </ol>
        </div>

        <div class="step step-slide" data-y="1600" data-x="2600">
            <h1>Building Up Your Team Of Mutants</h1>
            <div class="row">
                <div class="col-md-3">
                    <img data-jmpress="fade" class="img-responsive" src="img/mutants.jpg"/>
                </div>
                <div class="col-md-9">
                    <p data-jmpress="fade">
                        What we want to have:
                    </p>
                    <ul>
                        <li data-jmpress="fade">
                            <strong>Stability</strong>:
                            a re-run produces identical results
                        </li>
                        <li data-jmpress="fade">
                            <strong>Recall</strong>:
                            all the possible errors are made
                        </li>
                        <li data-jmpress="fade">
                            <strong>Precision</strong>:
                            there are no false positives
                        </li>
                        <li data-jmpress="fade" class="list-unstyled text-muted">
                            (aka <strong>Equivalent Mutations</strong>:
                            mutations which result in no observable change in behavior)
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="step step-slide" data-y="1600" data-x="3900">
            <h1>Running The Analysis</h1>
            <ol>
                <li data-jmpress="fade">Pick one mutant at a time</li>
                <li data-jmpress="fade">Inject it via Instrumentation API</li>
                <li data-jmpress="fade">Run the relevant tests until one fails</li>
                <li data-jmpress="fade" class="list-unstyled">
                    Watch out for:
                    <ul>
                        <li data-jmpress="fade">Infinite loops</li>
                        <li data-jmpress="fade">OOM and other failures</li>
                        <li data-jmpress="fade">RuntimeExceptions</li>
                    </ul>
                </li>
            </ol>
        </div>

        <!-- PITEST DETAILS END -->

        <!-- WHY USE PITEST -->

        <div class="step step-slide text-center" data-y="2400">
            <img data-jmpress="fade" class="graph" src="img/the-three-rules.jpg"/>
        </div>

        <div class="step step-slide text-center" data-y="2400" data-x="1300">
            <div class="v-center">
                <h2>&nbsp;</h2>
                <h1>Do Not Write Any Production Code</h1>
                <h1 data-jmpress="fade">Unless</h1>
                <h1 data-jmpress="fade">It Is To Make A Failing Test Pass</h1>
            </div>
        </div>

        <div class="step step-slide text-center" data-y="2400" data-x="2600">
            <div class="v-center">
                <h2>&nbsp;</h2>
                <h1>Do Not Write Any <span data-jmpress="appear">More</span> Unit Tests</h1>
                <h1 data-jmpress="fade">Than Is Sufficient To Fail</h1>
                <h1 data-jmpress="fade" class="text-muted">
                    (Compilation Failures Are Failures, Too)
                </h1>
            </div>
        </div>

        <div class="step step-slide text-center" data-y="2400" data-x="3900">
            <div class="v-center">
                <h2>&nbsp;</h2>
                <h1>Do Not Write Any More Production Code</h1>
                <h1 data-jmpress="fade">Than Is Sufficient To Pass</h1>
                <h1 data-jmpress="fade">
                    The One Failing Unit Test
                </h1>
            </div>
        </div>

        <div class="step step-slide" data-y="3600">
            <h1>Pitest Grants You Confidence</h1>
            <p data-jmpress="fade">
                A success story from TheLadders.com
                <ul>
                    <li data-jmpress="fade">
                        A project from scratch, PIT used from the start
                    </li>
                    <li data-jmpress="fade">
                        Code and Mutation Coverage of about <span class="text-success">95%</span>
                    </li>
                    <li data-jmpress="fade">
                        Needed to refactor the core to use event sourcing
                    </li>
                    <li data-jmpress="fade">
                        So they just did it
                    </li>
                    <li data-jmpress="fade">
                        And had no issues!<sup>*</sup>
                    </li>
                </ul>
            </p>
        </div>

        <!-- WHY USE PITEST ENDS -->

        <div class="step step-slide qr" data-y="-800" data-x="1300" id="links">
            <div class="text-center">
                <img class="graph" src="img/qr.png"/>

                <h2>
                    <a href="http://gvsmirnov.ru/docs/presentations/pitest/juc-july-2014.html">
                        goo.gl/OyAbcD
                    </a>
                </h2>
            </div>
        </div>

    </div>

    <script src="js/custom.js"></script>

    <script type="text/javascript">
        !function ($) {
            $(function(){

                $('#impress').jmpress({
                    "mouse": { clickSelects: false },
                    "beforeChange": function(element, eventData) {
                        element = $(element);
                        if(element.hasClass("visit-me")) {
                            element.addClass('visited');
                        }

                        updateCurrentSlide(element);
                    }
                });

                window.prettyPrint && prettyPrint()
                $('body').mousemove(function(e){
                    $('#laser').css('left', e.clientX).css('top', e.clientY);
                });
            });
        }(window.jQuery)
    </script>
</body>
</html>
