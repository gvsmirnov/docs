<!doctype html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
    <head>
        <meta charset="utf-8" />

        <title>Java mutation testing</title>

        <link href="css/impress.css" rel="stylesheet"/>
        <link href="css/prettify.css" rel="stylesheet"/>
        <link href="css/animation.css" rel="stylesheet"/>

        <script src="js/jquery.min.js"></script>
        <script src="js/jmpress.impress.js"></script>
        <script src="js/prettify.js"></script>

    </head>

    <body>
        <div id="impress">

            <div class="step slide" data-x="1500" style="text-align: center;">
                <h1>Мутационное тестирование</h1>
                <h2>или</h2>
		<h2>о чём молчит Code Coverage</h2>
                <br/>
                <br/>
                <br/>
                <br/>
                <br/>
		<br/>
		<br/>
                Gleb Smirnov<br />
		<a href="mailto:me@gvsmirnov.ru">me@gvsmirnov.ru</a>
            </div>

            <!--
            ***********************************
                       CODE COVERAGE
            ***********************************
            -->

            <div class="step" data-x="3000">
                <h2>Качество тестов иногда оставляет желать лучшего</h2>
                <pre class='mono prettyprint lang-java'>public class NodeMapperTest {

    @Test
    public void testGetMachineById() {
        // The boss says we should write tests.
        // Here you are, he-he-he.

        Assert.assertTrue(true);
    }

}</pre>
            </div>

            <div class="step" data-x="3000" data-y="1000">
                <h2>За ним можно следить с помощью Code Coverage</h2>
                <pre class="mono console"><span class="prompt">$</span> mvn clean -Dtest=NodeMapperTest#testGetMachineById test jacoco:report</pre>

                <pre class="mono prettyprint lang-java" data-jmpress="fade">
public class NodeMapper {

    //...

    public String getMachineById(long nodeId) {
<span class="nc">        if(nodeId2machine.containsKey(nodeId)) {</span>
<span class="nc">            return nodeId2machine.get(nodeId);</span>
        } else {
<span class="nc">            return DEFAULT_MACHINE_NAME;</span>
        }
    }

}
</pre>
            </div>

            <div class="step" data-x="3000" data-y="1600">
                <h2>Но Code Coverage очень легко обмануть</h2>
                <pre class='mono prettyprint lang-java'>private static final Map&lt;String, List&lt;Long&gt;&gt; MACHINES = /* ... */

@Test
public void testGetMachineById2() {
    NodeMapper nodeMapper = new NodeMapper(MACHINES);

    nodeMapper.getMachineById(0);
    nodeMapper.getMachineById(1);
}</pre>
            </div>

            <div class="step" data-x="3000" data-y="2400">
                <h2>И получить хорошие метрики</h2>
                <pre class="mono console"><span class="prompt">$</span> mvn clean -Dtest=NodeMapperTest#testGetMachineById2 test jacoco:report</pre>
                <pre class="mono prettyprint lang-java" data-jmpress="fade">
public class NodeMapper {

    //...

    public String getMachineById(long nodeId) {
<span class="fc bfc">        if(nodeId2machine.containsKey(nodeId)) {</span>
<span class="fc">            return nodeId2machine.get(nodeId);</span>
        } else {
<span class="fc">            return DEFAULT_MACHINE_NAME;</span>
        }
    }

}
</pre>
                <h3 class="mono success" data-jmpress="fade after 5ms">&gt; Code Coverage: 100%</h3>
            </div>

            <div class="step" data-x="3000" data-y="3200">
                <center><img src="img/yo-dawg.jpg"/></center>
            </div>

            <!--
            ***********************************
                     MUTATION TESTING
            ***********************************
            -->

            <div class="step" data-x="4500">
                <h2>Мутационное Тестирование судит судей</h2>
                <ol>
                    <li data-jmpress="fade">Запустить тесты</li>
                    <li data-jmpress="fade">Поменять что-то в исходниках</li>
                    <li data-jmpress="fade">Запустить тесты снова</li>
                    <li data-jmpress="fade">Какие-то тесты должны упасть</li>
                </ol>
                <h3 data-jmpress="fade">Если изменения в коде не заставляют упасть ни один тест, то участок кода,
                    скорее всего, плохо протестирован</h3>
            </div>

            <div class="step" data-x="4500" data-y="800">
                <h2>Мутационное Тестирование придумали уже давно</h2>
                <p>
                    <ul>
                        <li data-jmpress="fade">Richard Lipton предложил идею в 1971</li>
                        <li data-jmpress="fade">
                            Timothy Budd реализовал первую библиотеку<br/>
                            для FORTRAN в 1979<sup>[1]</sup>
                        </li>
                        <li style="margin-top: 20pt; list-style-type: none; color: #a9a9a9;" data-jmpress="fade">
                            <img src="img/nothing_happens.png" />
                        </li>
                        <li style="margin-top: 20pt;" data-jmpress="fade">
                            К 2010 мутационное тестирование наконец находит применение в индустрии
                        </li>
                    </ul>
                </p>
            </div>

            <div class="step" data-x="4500" data-y="1600">
                <h2>Хороших библиотек для Java мало</h2>
                <p>
                <ul>
                    <li>Javalanche</li>
                    <li>Jumble</li>
                    <li>Jester</li>
                    <li>Simple Jester</li>
                </ul>
                <div class="step spoiler" data-y="350">
                    <h3>
                        Все эти <span class="fail">не</span> хороши,
                        так как они как минимум <small class="remark">(одно из)</small>
                    </h3>
                    <ul>
                        <li>Заброшены</li>
                        <li>Устарели</li>
                        <li>Тормозят</li>
                        <li>Не поддерживают популярные библиотеки</li>
                    </ul>
                </div>
                </p>
            </div>

            <div class="step" data-x="4500" data-y="2400">
                <h2>Но есть Pitest (PIT)</h2>
                <p>
                    <ul>
                        <li data-jmpress="fade">Активно разрабатывается</li>
                        <li data-jmpress="fade">Производительность приемлема</li>
                        <li data-jmpress="fade">Открытый исходный код</li>
                        <li data-jmpress="fade">Поддерживает Java 7, Maven, JUnit, *Mock*, ...</li>
                    </ul>
                </p>
            </div>

            <div class="step" data-x="4500" data-y="3200">
                <h2>Таблица сравнения<sup>[2]</sup></h2>
                <table class="comparison-table">
                    <tr>
                        <td class="name">Система</td>
                        <td>Ant</td>
                        <td>Maven</td>
                        <td>Java 7</td>
                        <td>TestNG</td>
                        <td>*Mock*</td>
                        <td>Последнее обновление</td>
                    </tr>
                    <tr>
                        <td class="name">Javalanche</td>
                        <td class="no">NO</td>
                        <td class="no">NO</td>
                        <td class="no">NO</td>
                        <td class="no">NO</td>
                        <td>?</td>
                        <td>2011</td>
                    </tr>
                    <tr>
                        <td class="name">Jumble</td>
                        <td class="yes">YES</td>
                        <td class="no">NO</td>
                        <td class="no">NO</td>
                        <td class="no">NO</td>
                        <td class="yes">3/6</td>
                        <td class="yes">2013</td>
                    </tr>
                    <tr>
                        <td class="name">Jester</td>
                        <td class="no">NO</td>
                        <td class="no">NO</td>
                        <td class="no">NO</td>
                        <td class="no">NO</td>
                        <td>?</td>
                        <td>2005</td>
                    </tr>
                    <tr>
                        <td class="name">Simple Jester</td>
                        <td class="no">NO</td>
                        <td class="no">NO</td>
                        <td class="no">NO</td>
                        <td class="no">NO</td>
                        <td>?</td>
                        <td>2009</td>
                    </tr>
                    <tr>
                        <td class="name">PIT</td>
                        <td class="yes">YES</td>
                        <td class="yes">YES</td>
                        <td class="yes">YES</td>
                        <td class="yes">YES</td>
                        <td class="yes">6/6</td>
                        <td class="yes">Вчера</td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="4500" data-y="3600">
                <h1 class="success">Pitest жжот!</h1>
            </div>

            <div class="step" data-x="4500" data-y="4300">
                <h2>Pitest замечает, что тест бесполезен</h2>
                <pre class="mono console"><span class="prompt">$</span> mvn clean -Dtest=NodeMapperTest#testGetMachineById2 test pitest:mutationCoverage</pre>
                <table data-jmpress="fade">
                    <tr>
                        <td class="line-numbers"><pre class="mono">7



33
<span class="nc">34</span>
<span class="nc">35</span>
36
<span class="nc">37</span>
38
39
40
41</pre></td>
                        <td><pre class="mono prettyprint lang-java">public class NodeMapper {

    //...

    public String getMachineById(long nodeId) {
<span class="nc">        if(nodeId2machine.containsKey(nodeId)) {</span>
<span class="nc">            return nodeId2machine.get(nodeId);</span>
        } else {
<span class="nc">            return DEFAULT_MACHINE_NAME;</span>
        }
    }

}</pre></td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="4500" data-y="4300" data-rotate-y="90">
                <h2>PIT сломал исходный код (1)</h2>
                <pre class="mono prettyprint lang-java">public String getMachineById(long nodeId) {
    if(<span class="nb">!</span>nodeId2machine.containsKey(nodeId)) {
        return nodeId2machine.get(nodeId);
    } else {
        return DEFAULT_MACHINE_NAME;
    }
}</pre>
                    <li style="list-style: none;" class="nc mono">34: negated conditional : SURVIVED</li>
            </div>

            <div class="step" data-x="4500" data-y="4300" data-rotate-y="90" data-z="-1100">
                <h2>PIT сломал исходный код (2)</h2>
                <pre class="mono prettyprint lang-java">public String getMachineById(long nodeId) {
    if(nodeId2machine.containsKey(nodeId)) {
        <span class="nb">if(nodeId2machine.get(nodeId) != null) {
    return null;
} else {
    throw new RuntimeException();
}</span>
    } else {
        return DEFAULT_MACHINE_NAME;
    }
}</pre>
                    <li class="nc mono" style="list-style: none;">35: mutated return of Object value /* ... */ : SURVIVED</li>
            </div>

            <div class="step" data-x="4500" data-y="4300" data-rotate-y="90" data-z="-2200">
                <h2>PIT сломал исходный код (3)</h2>
                <pre class="mono prettyprint lang-java">public String getMachineById(long nodeId) {
    if(nodeId2machine.containsKey(nodeId)) {
        return nodeId2machine.get(nodeId);
    } else {
        <span class="nb">if(DEFAULT_MACHINE_NAME != null) {
    return null;
} else {
    throw new RuntimeException();
}</span>
    }
}</pre>
                <li class="nc mono" style="list-style: none;">37: mutated return of Object value /* ... */ : SURVIVED</li>
            </div>

            <div class="step" data-x="4500" data-y="4900">
                <h2>Придётся написать нормальный тест</h2>
                <pre class='mono prettyprint lang-java'>@Test
public void testGetMachineById3() {
    NodeMapper nodeMapper = new NodeMapper(MACHINES);

    Assert.assertEquals(NodeMapper.DEFAULT_MACHINE_NAME, nodeMapper.getMachineById(0));
    Assert.assertEquals(TEST_MACHINE_NAME, nodeMapper.getMachineById(1));
}</pre>
            </div>

            <div class="step" data-x="4500" data-y="5700">
                <pre class="mono console"><span class="prompt">$</span> mvn clean -Dtest=NodeMapperTest#testGetMachineById3 test pitest:mutationCoverage</pre>
                <table data-jmpress="fade">
                    <tr>
                        <td class="line-numbers"><pre class="mono">7



33
<span class="fc">34</span>
<span class="fc">35</span>
36
<span class="fc">37</span>
38
39
40
41</pre></td>
                        <td><pre class="mono prettyprint lang-java">public class NodeMapper {

    //...

    public String getMachineById(long nodeId) {
<span class="fc">        if(nodeId2machine.containsKey(nodeId)) {</span>
<span class="fc">            return nodeId2machine.get(nodeId);</span>
        } else {
<span class="fc">            return DEFAULT_MACHINE_NAME;</span>
        }
    }

}</pre></td>
                    </tr>
                </table>
                <ol class="mutation-list mono">
                    <li class="fc" data-jmpress="fade">34: negated conditional : KILLED</li>
                    <li class="fc" data-jmpress="fade">35: mutated return of Object value /* ... */ : KILLED</li>
                    <li class="fc" data-jmpress="fade">37: mutated return of Object value /* ... */ : KILLED</li>
                </ol>
            </div>

            <div class="step" data-x="4500" data-y="6800">
                <table>
                    <tr>
                        <td class="line-numbers"><pre class="mono">7

14


<span class="nc">26</span>
27

33
<span class="fc">34</span>
<span class="fc">35</span>
36
<span class="fc">37</span>
38
39
40
41</pre></td>
                        <td><pre class="mono prettyprint lang-java">public class NodeMapper {

    public NodeMapper(Map&lt;~&gt; machines, String defaultMachineName) {
        //...

<span class="nc">        this.defaultMachineName = defaultMachineName;</span>
    }

    public String getMachineById(long nodeId) {
<span class="fc">        if(nodeId2machine.containsKey(nodeId)) {</span>
<span class="fc">            return nodeId2machine.get(nodeId);</span>
        } else {
<span class="fc">            return DEFAULT_MACHINE_NAME;</span> <span data-jmpress="fade">// &lt;-- oops!</span>
        }
    }

}</pre></td>
                    </tr>
                </table>
                <ol class="mutation-list mono">
                    <li class="nc">26: Removed assignment to member variable defaultMachineName : SURVIVED</li>
                </ol>
            </div>

            <!--
            ***********************************
                      UNDER THE HOOD
            ***********************************
            -->

            <div class="step" data-x="6000">
                <h2>Протестируйте свои тесты в три простых шага</h2>
                <ol>
                    <li data-jmpress="fade">Выбрать что-нибудь, чтобы помутировать</li>
                    <li data-jmpress="fade">Помутировать что-нибудь</li>
                    <li data-jmpress="fade">Проверить, не упало ли что-нибудь</li>
                </ol>
            </div>

            <div class="step" data-x="6000" data-y="800">
                <h2>Выбор целей для мутации</h2>
                <ol>
                    <li data-jmpress="fade">Скомпилировать исходники в байт-код</li>
                    <li data-jmpress="fade">Запустить нужные тесты</li>
                    <li data-jmpress="fade">Собрать детальный Code Coverage:<br/>
                        какие тесты выполняют какие инструкции</li>
                </ol>
            </div>

            <div class="step" data-x="6000" data-y="1600">
                <h2>Создание мутантов</h2>
                <img src="img/genetic-experiments.png" align="left" style="padding-right: 80px;">
                <div>

                    <ol>
                        <li data-jmpress="fade">Сгенерировать классы-мутанты с помощью ASM</li>
                        <li data-jmpress="fade">
                            Мутации должны быть предсказуемыми и стабильными<br/>
                            От запуска к запуску поведение не должно меняться
                        </li>

                        <li data-jmpress="fade">
                            Должно быть как можно меньше эквивалентных мутаций<br/><br/>
                            <span data-jmpress="fade">Эквивалентная мутация &dash; мутация, в результате которой наблюдаемое поведение программы не меняется<br/><br/>Выжившие эквивалентные мутации &dash; ложные срабатывания.</span>
                        </li>

                    </ol>
                </div>
            </div>

            <!-- MUTATORS -->

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90">
                <h2>CONDITIONALS_BOUNDARY<br/>
                    <small class="success">[on by default]</small>
                </h2>
                <p>Меняет операции сравнения: включительные на невключительные и наоборот</p>
                <table class="before-after">
                    <tr>
                        <td><p>Before:</p>
                <pre class="mono prettyprint lang-java">if (a &lt; b) {
  // do something
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">if (a <span class="nb">&lt;=</span> b) {
  // do something
}</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-1100">
                <h2>NEGATE_CONDITIONALS
                    <small class="success">[on by default]</small>
                </h2>
                <p>Меняет условия, заменяя их на противоположные</p>
                <table class="before-after">
                    <tr>
                        <td><p>Before:</p>
                <pre class="mono prettyprint lang-java">if (foo()) {
  // do something
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">if (<span class="nb">!</span>foo()) {
  // do something
}</pre>
                        </td>
                    </tr>
                </table>
            </div>
            
	    <div class="step spoiler" style="text-align: center;" data-duration="1200" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-1100">
                <img src="img/total-recall.jpg"/>
	    </div>

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-2200">
                <h2>MATH
                    <small class="success">[on by default]</small>
                </h2>
                <p>Заменяет бинарные операторы по таблице</p>
                <table class="before-after">
                    <tr>
                        <td><p>Before:</p>
                            <pre class="mono prettyprint lang-java">int foo = bar + baz;</pre>
                        </td>
                        <td>
                            <p>After:</p>
                            <pre class="mono prettyprint lang-java">int foo = bar <span class="nb">-</span> baz;</pre>
                        </td>
                    </tr>
                </table>
                <p data-jmpress="fade">Также меняет инкременты/декременты полей</p>
                <table>
                    <tr>
                        <td>
                    <pre data-jmpress="fade" class="mono prettyprint lang-java">class Foo {
    private int a;
    //...
    void bar() {
        a++;
    }
}</pre>
                        </td>
                        <td>
                            <span data-jmpress="fade" class="huge">&nbsp;&rarr;&nbsp;</span>
                        </td>
                        <td>
<pre data-jmpress="fade" class="mono prettyprint lang-java">0: aload_0
1: dup
2: getfield
5: iconst_1
6: iadd <span data-jmpress="fade"># &larr; сложение</span>
7: putfield
10: return</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-3300">
                <h2>INCREMENTS
                    <small class="success">[on by default]</small>
                </h2>
                <p>
                    Заменяет операции инкремента на декремент и наоборот<br/>
                </p>
                <table class="before-after">
                    <tr>
                        <td><p>Before:</p>
                            <pre class="mono prettyprint lang-java">counter ++;</pre>
                        </td>
                        <td>
                            <p>After:</p>
                            <pre class="mono prettyprint lang-java">counter <span class="nb">--</span>;</pre>
                        </td>
                    </tr>
                </table>
                <p data-jmpress="fade">
                    NB: Работает только для локальных переменных
                </p>
            </div>

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-4400">
                <h2>INVERT_NEGS
                    <small class="success">[on by default]</small>
                </h2>
                <p>Убирает унарный минус у чисел</p>
                <table class="before-after">
                    <tr>
                        <td><p>Before:</p>
                            <pre class="mono prettyprint lang-java">int a = -b;</pre>
                        </td>
                        <td>
                            <p>After:</p>
                            <pre class="mono prettyprint lang-java">int a = <span class="nb">b</span>;</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-5500">
                <h2>RETURN_VALS
                    <small class="success">[on by default]</small>
                </h2>
                <p>Меняет возвращаемое методом значение</p>
                <table class="before-after">
                    <tr>
                        <td><p>Before:</p>
                <pre class="mono prettyprint lang-java">public int foo() {
    //...
    return true;
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">public int foo() {
    //...
    return <span class="nb">false</span>;
}</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-6600">
                <h2>VOID_METHOD_CALLS
                    <small class="success">[on by default]</small>
                </h2>
                <p>Удаляет вызов void-методов</p>
                <table class="before-after">
                    <tr>
                        <td>
                            <p>Before:</p>
                <pre class="mono prettyprint lang-java">public void foo() {/* ... */ }

public void bar() {
    //...
    foo();
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">public void foo() {/* ... */ }

public void bar() {
    //...
    <span class="nb">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
}</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-7700">
                <h2>INLINE_CONSTS
                    <small class="fail">[off by default]</small>
                </h2>
                <p>Меняет значения, присваемые не-final локальным переменным</p>
                <table class="before-after">
                    <tr>
                        <td><p>Before:</p>
                <pre class="mono prettyprint lang-java">public int foo() {
    int answer = 42;
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">public int foo() {
    int answer = <span class="nb">43</span>;
}</pre>
                        </td>
                    </tr>
                </table>
                <p data-jmpress="fade">Может порождать много Runtime Exceptions</p>
            </div>

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-8800">
                <h2>NON_VOID_METHOD_CALLS<br/>
                    <small class="fail">[off by default]</small>
                </h2>
                <p>Удаляет вызов метода, подставляет присвоение значения по умолчанию</p>
                <table class="before-after">
                    <tr>
                        <td>
                            <p>Before:</p>
                <pre class="mono prettyprint lang-java">public String foo() {/* ... */ }

public void bar() {
    //...
    String foo = foo();
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">public String foo() {/* ... */ }

public void bar() {
    //...
    String foo = <span class="nb">null</span>;
}</pre>
                        </td>
                    </tr>
                </table>
                <p data-jmpress="fade">Порождает много эквивалентных мутаций, много NullPointerException</p>
            </div>

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-10200">
                <h2>CONSTRUCTOR_CALLS
                    <small class="fail">[off by default]</small>
                </h2>
                <p>Заменяет вызов конструктора присвоением null</p>
                <table class="before-after">
                    <tr>
                        <td>
                            <p>Before:</p>
                <pre class="mono prettyprint lang-java">public void bar() {
    Object foo = new Object();
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">public void bar() {
    Object foo = <span class="nb">null</span>;
}</pre>
                        </td>
                    </tr>
                </table>
                <p data-jmpress="fade">Порождает много NullPointerException</p>
            </div>

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-12000">
                <h2>EXPERIMENTAL_INLINE_CONSTS<br/>
                    <small class="fail">[off by default]</small>
                </h2>
                <p>Пока не стабильная, но более консистентная замена INLINE_CONSTS</p>
                <table class="before-after">
                    <tr>
                        <td>
                            <p>Before:</p>
                            <pre class="mono prettyprint lang-java">short s = Byte.MAX_VALUE;</pre>
                        </td>
                        <td>
                            <p>After:</p>
                            <pre class="mono prettyprint lang-java">short s = <span class="nb">Byte.MIN_VALUE</span>;</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-13500">
                <h2>EXPERIMENTAL_MEMBER_VARIABLE<br/>
                    <small class="fail">[off by default]</small>
                </h2>
                <p>Заменяет значения, присвоенные полям при инициализации,
                    <br/>на значения по умолчанию</p>
                <table class="before-after">
                    <tr>
                        <td>
                            <p>Before:</p>
                <pre class="mono prettyprint lang-java">public class Foo {
    private int magic = 13;
    //...
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">public class Foo {
    private int magic = <span class="nb">0</span>;
    //...
}</pre>
                        </td>
                    </tr>
                </table>
                <p>Может порождать много эквивалентных мутаций</p>
            </div>

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-15000">
                <h2>EXPERIMENTAL_SWITCH
                    <small class="fail">[off by default]</small>
                </h2>
                <table class="before-after">
                    <tr>
                        <td>
                            <p>Before:</p>
                <pre class="mono prettyprint lang-java">int a;
//...
switch(a) {
    case 1: doFirst(); break;
    case 2: doSecond(); break;
    default: doDefault(); break;
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">int a;
//...
switch(a) {
    case 1: <span class="nb">doDefault()</span>; break;
    case 2: <span class="nb">doDefault()</span>; break;
    default: <span class="nb">doFirst()</span>; break;
}</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="6000" data-y="2400">
                <h2>Запустить тесты, сгенерировать отчёты</h2>
                <ol>
                    <li data-jmpress="fade">Выбрать очередного мутанта</li>
                    <li data-jmpress="fade">С помощью Instrumentation API подменить классы</li>
                    <li data-jmpress="fade">
                        Запускать с ним тесты до первого упавшего (и убившего этим мутанта)<br/>
                        <span data-jmpress="fade">Опасаться:</span>
                        <ul>
                            <li data-jmpress="fade after 1ms">Долго работающих тестов (мог появиться бесконечный цикл)</li>
                            <li data-jmpress="fade">OOM (могла появиться утечка памяти)</li>
                            <li data-jmpress="fade">Ошибок валидации (сгенерировался некорректный байткод)</li>
                            <li data-jmpress="fade">Runtime exceptions</li>
                        </ul>
                    </li>
                </ol>
            </div>

            <div class="step" data-x="6000" data-y="3200">
                <h2>Единица работы &dash; исходный класс</h2>
                <center><img src="img/balancing.png"/></center>
            </div>

            <!--
            ***********************************
                      SUCCESS STORIES
            ***********************************
            -->

            <div class="step" data-x="9000" style="text-align: center;">
                <h2>Три закона TDD</h2>
		    <img data-jmpress="fade" src="img/fight-club.jpg" />
            </div>

	    <div class="step" data-x="10100">
                 <h2>Первый Закон TDD</h2>
		 <p>Нельзя писать продакшн-код, если это не чинит падающий тест</p>
	    </div>

	    <div class="step" data-x="11200">
                 <h2>Второй Закон TDD</h2>
		 <p>Нельзя писать тестов больше, чем нужно для создания ошибки <br/><span class="remark">(ошибка компиляции &dash; тоже ошибка)</span></p>
	    </div>

	    <div class="step" data-x="12300">
                 <h2>Третий Закон TDD</h2>
		 <p>Нельзя писать больше продакшн-кода, чем нужно, чтобы единственный <br/> падающий тест заработал</p>
	    </div>

            <div class="step" data-x="9000" data-y=800>
                <h2>PIT даёт <span class="success">уверенность</span> в тестах</h2>
                <p data-jmpress="fade">
                    История успеха от TheLadders.com<sup>[4]</sup>
                    <ul>
                        <li data-jmpress="fade">Новый проект с нуля, используют Mutation Testing с самого начала</li>
                        <li data-jmpress="fade">Code and Mutation Coverage около <span class="success">95%</span></li>
                        <li data-jmpress="fade">Потребовалось перевести ядро системы на event sourcing</li>
                        <li data-jmpress="fade">Код отрефакторили, добились того, чтобы все тесты проходили, и выкатились в продакшн</li>
                        <li data-jmpress="fade">Ни единого разрыва!</li>
                    </ul>
                </p>
            </div>


            <!--
            ***********************************
                      TRYING OUT
            ***********************************
            -->

            <div class="step" data-x="7500">
                <h2>Это же должно жутко тормозить!</h2>
                <p>
                    Возьмём большую и хорошо покрытую тестами библиотеку и проверим экспериментально
                </p>
                <h2 data-jmpress="fade">Apache commons-math</h2>
                <ul>
                    <li data-jmpress="fade">Много сложных математических алгоритмов</li>
                    <li data-jmpress="fade">177 тысяч строк исходного кода</li>
                    <li data-jmpress="fade">Около 5000 тестов в 109 тысяч строк кода</li>
                </ul>
            </div>

            <div class="step" data-x="7500" data-y="700">
                <pre class="mono console"><span class="prompt">$</span> ./prepare-commons-math3.sh && cd commons-math3

<span data-jmpress="appear">+ svn checkout http://svn.apache.org/repos/asf/commons/proper/math/trunk@1455261 commons-math3</span>
<span data-jmpress="appear after 100ms">A    commons-math3/RELEASE-NOTES.txt</span>
<span data-jmpress="appear after 1s">A    commons-math3/...
 U   commons-math3</span>
<span data-jmpress="appear after 1s">Checked out revision 1455261.</span>

<span data-jmpress="appear">+ patch commons-math3/pom.xml commons-math3-pom-patch.diff</span>
<span data-jmpress="appear after 1s">patching file commons-math3/pom.xml</span></pre>
            </div>

            <div class="step" data-x="7500" data-y="2000">
                <h2>Baseline: просто Code Coverage</h2>
                <pre class="mono console"><span class="prompt">$</span> mvn clean test jacoco:report

<span data-jmpress="appear">...</span>

<span data-jmpress="appear after 300ms">Results :

Tests run: 4901, Failures: 0, Errors: 0, Skipped: 43

[INFO]
[INFO] --- jacoco-maven-plugin:0.6.2.201302030002:report (default-cli) @ commons-math3 ---
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: <span class="nb">7:46.820s</span></span></pre>
                

                <p class="info" data-jmpress="appear">
                    Общий Code Coverage составляет 92%
                </p>

            </div>
	    
	    <div data-x="7500" data-y="2000" class="step spoiler warn shipilev">
                <img src="img/shipilev.png" align="left"/>
                NB: maven наверняка при первом запуске будет скачивать десятки jar-файлов.<br/>
                Не учитывайте это в своих в измерениях.
                <br/><br/>
                И вообще, делайте бенчмарки хорошо и не делайте их плохо.
            </div>

            <div class="step" data-x="7500" data-y="3000">
                <h2>Мутационный анализ</h2>
                <pre class="mono console"><span class="prompt">$</span> mvn clean test pitest:mutationCoverage
<span data-jmpress="appear">...</span>
<span data-jmpress="appear after 300ms">================================================================================
- Timings
================================================================================</span>
<span data-jmpress="appear">> scan classpath : < 1 second</span>
<span data-jmpress="appear">> coverage and dependency analysis : <span class="nb">27 minutes and 31 seconds</span></span>
<span data-jmpress="appear">> build mutation tests : 7 seconds</span>
<span data-jmpress="appear">> run mutation analysis : <span class="nb">3 hours, 47 minutes and 7 seconds</span></span>
<span data-jmpress="appear">--------------------------------------------------------------------------------
> Total  : <span class="nb">4 hours, 14 minutes and 46 seconds</span></span></pre>

                <p class="info" data-jmpress="appear">
                    Общий Mutation Coverage составляет 79%
                </p>

            </div>

            <div class="step spoiler" data-x="7500" data-y="3000" style='text-align: center;'>
                <img src="img/slowpoke.png"/>
            </div>

            <div class="step" data-x="7500" data-y="4000">
                <h2>Можно добавить ещё потоков</h2>
                <pre class="mono console"><span class="prompt">$</span> mvn clean test pitest:mutationCoverage <span class="nb">-Dpit.threads=2</span>
<span data-jmpress="appear">...</span>
<span data-jmpress="appear after 300ms">================================================================================
- Timings
================================================================================</span>
<span data-jmpress="appear">> scan classpath : < 1 second</span>
<span data-jmpress="appear">> coverage and dependency analysis : <span class="nb">27 minutes and 28 seconds</span></span>
<span data-jmpress="appear">> build mutation tests : 3 seconds</span>
<span data-jmpress="appear">> run mutation analysis : <span class="nb">2 hours, 2 minutes and 1 seconds</span></span>
<span data-jmpress="appear">--------------------------------------------------------------------------------
> Total  : <span class="nb">2 hours, 29 minutes and 33 seconds</span></span></pre>
                <p class="info" data-jmpress="appear">
                    Улучшение почти линейное
                </p>

            </div>

            <div class="step graph" data-x="7500" data-y="4000" data-rotate-y="90">
                <h2>Время анализа apache commons-math3</h2>
                <img src="img/performance-graph-commons-math3.png"/>
            </div>

            <div class="step graph" data-x="7500" data-y="4000" data-rotate-y="90" data-z="-1500">
                <h2>Нагрузка на ядра CPU</h2>
                <img src="img/core-load.png"/>
            </div>

            <div class="step graph" data-x="7500" data-y="4000" data-rotate-y="90" data-z="-3000">
                <h2>Нагрузка на ядра CPU</h2>
                <img src="img/core-load-explained.png"/>
            </div>

            <div class="step graph" data-x="7500" data-y="4000" data-rotate-y="90" data-z="-4500">
                <h2>Улучшено в pitest 0.30</h2>
                <img src="img/core-load-improved.png"/>
            </div>

            <div class="step graph" data-x="7500" data-y="4000" data-rotate-y="90" data-z="-6000">
                <h2>Улучшено ещё в pitest 0.31</h2>
                <img src="img/core-load-improved-more.png"/>
            </div>

            <div class="step graph" data-x="7500" data-y="4000" data-rotate-y="90" data-z="-7500">
                <img src="img/performance-comparison.png"/>
	    </div>

            <div class="step" data-x="7500" data-y="5300">
                <h2>Инкрементальный анализ</h2>
                <h3 data-jmpress="fade">Между запусками сохраняются мета-данные</h3>
                <ul>
                    <li data-jmpress="fade">Хеши всех тестируемых классов</li>
                    <li data-jmpress="fade">Хеши всех запущенных тестов</li>
                    <li data-jmpress="fade">Результаты анализа</li>
                </ul>
            </div>

            <div class="step" data-x="7500" data-y="6000">
                <h3>При повторном запуске применяются эвристики<br/>
                Мутант не будет снова проверяться, если он в прошлый раз</h3>
                <ul>
                    <li data-jmpress="fade"><font color="#00008b">затаймаутился</font>, а класс с ним не изменился</li>
                    <li data-jmpress="fade">был <font color="#008b00">убит</font>, а ни класс ни тест не изменились</li>
                    <li data-jmpress="fade"><font color="#8b0000">выжил</font>, а новых тестов для него нет, и старые не изменились</li>
                </ul>
            </div>

            <div class="step" data-x="7500" data-y="6700">
                <h3>А что с зависимостями?</h3>
                <p data-jmpress="fade">
                    PIT учитывает только изменения в самом классе, в его предках и в outer классе, если он есть<br/><br/>
                    <span data-jmpress="fade">Но не учитывает изменения в используемых классах</span>
                </p>
            </div>

            <div class="step" data-x="7500" data-y="7600">
                <h2>Overhead инкрементального анализа</h2>
                <pre class="mono console"><span class="prompt">$</span> mvn clean test pitest:mutationCoverage <span class="nb">-P pit-history</span> -Dpit.threads=4

<span data-jmpress="fade">...
================================================================================
- Timings
================================================================================
> scan classpath : < 1 second
> coverage and dependency analysis : <span class="nb">7 minutes and 15 seconds</span>
> build mutation tests : 2 seconds
> run mutation analysis : <span class="nb">55 minutes and 41 seconds</span>
--------------------------------------------------------------------------------
> Total  : <span class="nb">1 hours, 2 minutes and 59 seconds</span></span></pre>

                <p class="info" data-jmpress="fade">
                    Сохранение мета-информации почти бесплатное
                </p>
            </div>

            <div class="step" data-x="7500" data-y="7600" data-rotate-y="90">
                <h2>PIT обнаружил бесполезный код!</h2>
                <table style="padding-top: 1px; margin-top: -60px;">
                    <tr>
                        <td class="line-numbers"><pre class="mono">


193
194
<span class="fc">195
196
197
198
199</span>
<span class="nc" data-jmpress="become-green">200</span>
<span class="fc">201
202
203</span>
<span data-jmpress="disappear after 1ms">204</span></pre></td>
                        <td><pre class="mono prettyprint lang-java">// In org.apache.commons.math3.linear.MatrixUtils

public static &lt;T extends FieldElement&lt;T&gt;&gt; FieldMatrix&lt;T&gt;
createFieldIdentityMatrix(final Field&lt;T&gt; field, final int dimension) {
<span class="fc">    final T zero = field.getZero();
    final T one  = field.getOne();
    final T[][] d = MathArrays.buildArray(field, dimension, dimension);
    for (int row = 0; row < dimension; row++) {
        final T[] dRow = d[row];</span><span class="nc" data-jmpress="disappear after 1ms">
        Arrays.fill(dRow, zero);</span>
<span class="fc">        dRow[row] = one;
    }
    return new Array2DRowFieldMatrix&lt;T&gt;(field, d, false);</span>
}</pre></td>
                    </tr>
                </table>
                <h3>Mutations</h3>
                <ol class="mutation-list mono">
                    <li class="nc">200: removed call to java/util/Arrays::fill : SURVIVED</li>
                </ol>
            </div>

            <div class="step" data-x="7500" data-y="7600" data-rotate-y="90" data-z="-1500">
                <h2>Запустим тесты снова</h2>
                <pre class="mono console"><span class="prompt">$</span> mvn clean test pitest:mutationCoverage <span class="nb">-P pit-history</span> -Dpit.threads=24

<span data-jmpress="fade">...
================================================================================
- Timings
================================================================================
> scan classpath : < 1 second</span>
<span data-jmpress="fade">> coverage and dependency analysis : <span class="nb">7 minutes and 3 seconds</span>
> build mutation tests : 1 minutes and 1 seconds</span>
<span data-jmpress="fade">> run mutation analysis : <span class="nb">56 seconds</span></span>
<span data-jmpress="fade">--------------------------------------------------------------------------------
> Total  : <span class="nb">9 minutes and 0 seconds</span>
--------------------------------------------------------------------------------</span></pre>
            </div>

            <div class="step" data-x="7500" data-y="8600">
                <h2>На менее крупных проектах время работы несущественно</h2>
                <p data-jmpress="fade"><b>Joda Time</b> &dash; библиотека, позволяющая удобно работать с датами и временем</p>
                <ul>
                    <li data-jmpress="fade">68 тысяч строк кода</li>
                    <li data-jmpress="fade">70 тысяч строк кода в тестах</li>
                    <li data-jmpress="fade"><h2>Мутационный анализ выполняется<br/>за 5 минут</h2></li>
                </ul>
            </div>

            <div class="step" id="reading-material" data-x="1100" data-y="800">
                <h2>Полезно почитать</h2>
                <ol>
                    <li>Mutation Analysis [1979]: Budd, Lipton, DeNillo, Sayward<br/>
                        <a href="http://www.cs.yale.edu/publications/techreports/tr155.pdf">
                            http://www.cs.yale.edu/publications/techreports/tr155.pdf
                        </a>
                    </li>
                    <li>
                        Detailed comparison of java mutation testing frameworks<br/>
                        <a href="http://pitest.org/java_mutation_testing_systems">
                            http://pitest.org/java_mutation_testing_systems
                        </a>
                    </li>
                    <li>
                        The three laws of TDD <br/>
                        <a href="http://butunclebob.com/ArticleS.UncleBob.TheThreeRulesOfTdd">
                            http://butunclebob.com/ArticleS.UncleBob.TheThreeRulesOfTdd
                        </a>
                    </li>
                    <li>
                        Mutation Testing With PIT: A Step Beyond Normal Code Coverage<br/>
                        <a href="http://dev.theladders.com/2013/02/mutation-testing-with-pit-a-step-beyond-normal-code-coverage/">
                            http://dev.theladders.com/2013/02/mutation-testing-with-pit-a-step-beyond-normal-code-coverage/
                        </a>
                    </li>
                </ol>
            </div>

            <div class="step" id="try-me" data-x="1100" data-y="1600">
                <h2>Сделай сам</h2>
                <pre class="console mono">$ git clone git@github.com:gvsmirnov/docs.git
$ cd docs/presentations/java-mutation-testing</pre>
                <h2>Снова посмотреть презентацию</h2>
                <p><a href="http://gvsmirnov.ru/docs/presentations/java-mutation-testing/">http://gvsmirnov.ru/docs/presentations/java-mutation-testing/</a><br/>
                    <small class="remark">Точно работает в Yandex.Browser и Google Chrome последних версий на Mac OS X</small>
                </p>
            </div>

	    <div class="step graph" id="qr" data-x="1100" data-y="2600">
                <img src="img/qr.png"/>
	    </div>

            <div id="overview" class="step" data-x="3000" data-y="1500" data-scale="10"></div>
        </div>

        <script type="text/javascript">
            $(function() {
                    $('#impress').jmpress({
                        "mouse": { clickSelects: false },
                        "beforeChange": function(element, eventData) {
                            element = $(element);
                            if(element.is('tr')) {
                                element.addClass('visited'); // code should not be hidden after visiting
                            }
                        }
                    });
            });

            prettyPrint();
        </script>
    </body>
</html>




