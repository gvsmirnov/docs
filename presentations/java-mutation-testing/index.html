<!doctype html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
    <head>
        <meta charset="utf-8" />

        <title>Java Mutation Analysis</title>

        <link href="css/impress.css" rel="stylesheet"/>
        <link href="css/prettify.css" rel="stylesheet"/>
        <link href="css/animation.css" rel="stylesheet"/>

        <script src="js/jquery.min.js"></script>
        <script src="js/jmpress.impress.js"></script>
        <script src="js/prettify.js"></script>

    </head>

    <body>
        <div id="impress">

            <div class="step slide" data-x="1500" style="text-align: center;">
                <h1>Mutation Analysis:</h1>
		<h2>What Code Coverage Doesn't Tell Us</h2>
                <br/>
                <br/>
                <br/>
                <br/>
                <br/>
		<br/>
		<br/>
                Gleb Smirnov<br />
		<a href="mailto:me@gvsmirnov.ru">me@gvsmirnov.ru</a>
            </div>

            <!--
            ***********************************
                       CODE COVERAGE
            ***********************************
            -->

            <div class="step" data-x="3000">
                <h2>Sometimes, the tests leave a lot to be desired</h2>
                <pre class='mono prettyprint lang-java'>public class NodeMapperTest {

    @Test
    public void testGetMachineById() {
        // The boss says we should write tests.
        // Well, here you are. He-he.

        Assert.assertTrue(true);
    }

}</pre>
            </div>

            <div class="step" data-x="3000" data-y="1000">
                <h2>And we can check that using Code Coverage</h2>
                <pre class="mono console"><span class="prompt">$</span> mvn clean -Dtest=NodeMapperTest#testGetMachineById test jacoco:report</pre>

                <pre class="mono prettyprint lang-java" data-jmpress="fade">
public class NodeMapper {

    //...

    public String getMachineById(long nodeId) {
<span class="nc">        if(nodeId2machine.containsKey(nodeId)) {</span>
<span class="nc">            return nodeId2machine.get(nodeId);</span>
        } else {
<span class="nc">            return DEFAULT_MACHINE_NAME;</span>
        }
    }

}
</pre>
            </div>

            <div class="step" data-x="3000" data-y="1600">
                <h2>But Code Coverage is easily tricked</h2>
                <pre class='mono prettyprint lang-java'>private static final Map&lt;String, List&lt;Long&gt;&gt; MACHINES = /* ... */

@Test
public void testGetMachineById2() {
    NodeMapper nodeMapper = new NodeMapper(MACHINES);

    nodeMapper.getMachineById(0);
    nodeMapper.getMachineById(1);
}</pre>
            </div>

            <div class="step" data-x="3000" data-y="2400">
                <h2>And the reports are saying it's cool</h2>
                <pre class="mono console"><span class="prompt">$</span> mvn clean -Dtest=NodeMapperTest#testGetMachineById2 test jacoco:report</pre>
                <pre class="mono prettyprint lang-java" data-jmpress="fade">
public class NodeMapper {

    //...

    public String getMachineById(long nodeId) {
<span class="fc bfc">        if(nodeId2machine.containsKey(nodeId)) {</span>
<span class="fc">            return nodeId2machine.get(nodeId);</span>
        } else {
<span class="fc">            return DEFAULT_MACHINE_NAME;</span>
        }
    }

}
</pre>
                <h3 class="mono success" data-jmpress="fade after 5ms">&gt; Code Coverage: 100%</h3>
            </div>

            <div class="step" data-x="3000" data-y="3200">
                <center><h1>(except that it's not cool at all)</h1></center>
            </div>

            <div class="step spoiler" data-x="3000" data-y="3200">
                <center><img src="img/zoidberg.jpg"/></center>
            </div>

            <!--
            ***********************************
                     MUTATION TESTING
            ***********************************
            -->

            <div class="step" data-x="4500">
                <h2>Mutation Analysis judges the judges</h2>
                <ol>
                    <li data-jmpress="fade">Run the tests</li>
                    <li data-jmpress="fade">Change the sources</li>
                    <li data-jmpress="fade">Run the tests again</li>
                    <li data-jmpress="fade">Some tests have to fail</li>
                </ol>
                <h3 data-jmpress="fade">If a change is not making any test fail, the line is <span class="nc">not covered</span>.</h3>
                <h3 data-jmpress="fade">Otherwise, the changed line is considered to be <span class="fc">covered</span></h3>
            </div>

            <div class="step" data-x="4500" data-y="800">
                <h2>The notion itself is not new at all</h2>
                <p>
                    <ul>
                        <li data-jmpress="fade">Richard Lipton suggested the idea 1971</li>
                        <li data-jmpress="fade">
                            Timothy Budd implemented the first FORTRAN framework in 1979<sup>[1]</sup>
                        </li>
                    </ul>
                </p>
            </div>

            <div class="step spoiler" data-x="4500" data-y="800">
                <center><img src="img/snorlax.jpg"/></center>
            </div>

            <div class="step" data-x="4500" data-y="1600">
                <h2>There are few good java libraries out there</h2>
                <p>
                <ul>
                    <li>Javalanche</li>
                    <li>Jumble</li>
                    <li>Jester</li>
                    <li>Simple Jester</li>
                </ul>
                <div class="step spoiler" data-y="350">
                    <h3>
                        All of the above are <span class="fail">not</span> good,
                        as they are <small class="remark">(at least one of)</small>
                    </h3>
                    <ul>
                        <li>Abandoned</li>
                        <li>Outdated</li>
                        <li>Painfully slow</li>
                        <li>Don't support the required frameworks</li>
                    </ul>
                </div>
                </p>
            </div>

            <div class="step" data-x="4500" data-y="2400">
                <h2>Then there's pitest <span class="remark">aka PIT</span></h2>
                <p>
                    <ul>
                        <li data-jmpress="fade">Actively developed</li>
                        <li data-jmpress="fade">Acceptable performance</li>
                        <li data-jmpress="fade">Open Source</li>
                        <li data-jmpress="fade">Supports Java 7, Maven, JUnit, *Mock* etc.</li>
                    </ul>
                </p>
            </div>

            <div class="step" data-x="4500" data-y="3200">
                <h2>Comparison table<sup>[2]</sup></h2>
                <table class="comparison-table">
                    <tr>
                        <td class="name">System</td>
                        <td>Ant</td>
                        <td>Maven</td>
                        <td>Java 7</td>
                        <td>TestNG</td>
                        <td>*Mock*</td>
                        <td>Last Updated</td>
                    </tr>
                    <tr>
                        <td class="name">Javalanche</td>
                        <td class="no">NO</td>
                        <td class="no">NO</td>
                        <td class="no">NO</td>
                        <td class="no">NO</td>
                        <td>?</td>
                        <td>2011</td>
                    </tr>
                    <tr>
                        <td class="name">Jumble</td>
                        <td class="yes">YES</td>
                        <td class="no">NO</td>
                        <td class="no">NO</td>
                        <td class="no">NO</td>
                        <td class="yes">3/6</td>
                        <td class="yes">2013</td>
                    </tr>
                    <tr>
                        <td class="name">Jester</td>
                        <td class="no">NO</td>
                        <td class="no">NO</td>
                        <td class="no">NO</td>
                        <td class="no">NO</td>
                        <td>?</td>
                        <td>2005</td>
                    </tr>
                    <tr>
                        <td class="name">Simple Jester</td>
                        <td class="no">NO</td>
                        <td class="no">NO</td>
                        <td class="no">NO</td>
                        <td class="no">NO</td>
                        <td>?</td>
                        <td>2009</td>
                    </tr>
                    <tr>
                        <td class="name">PIT</td>
                        <td class="yes">YES</td>
                        <td class="yes">YES</td>
                        <td class="yes">YES</td>
                        <td class="yes">YES</td>
                        <td class="yes">6/6</td>
                        <td class="yes">Yesterday</td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="4500" data-y="3600">
                <h1 class="success">Pitest rocks!</h1>
            </div>

            <div class="step" data-x="4500" data-y="4300">
                <h2>PIT detects the useless test</h2>
                <pre class="mono console"><span class="prompt">$</span> mvn clean -Dtest=NodeMapperTest#testGetMachineById2 test pitest:mutationCoverage</pre>
                <table data-jmpress="fade">
                    <tr>
                        <td class="line-numbers"><pre class="mono">7



33
<span class="nc">34</span>
<span class="nc">35</span>
36
<span class="nc">37</span>
38
39
40
41</pre></td>
                        <td><pre class="mono prettyprint lang-java">public class NodeMapper {

    //...

    public String getMachineById(long nodeId) {
<span class="nc">        if(nodeId2machine.containsKey(nodeId)) {</span>
<span class="nc">            return nodeId2machine.get(nodeId);</span>
        } else {
<span class="nc">            return DEFAULT_MACHINE_NAME;</span>
        }
    }

}</pre></td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="4500" data-y="4300" data-rotate-y="90">
                <h2>PIT messes with your code (1)</h2>
                <pre class="mono prettyprint lang-java">public String getMachineById(long nodeId) {
    if(<span class="nb">!</span>nodeId2machine.containsKey(nodeId)) {
        return nodeId2machine.get(nodeId);
    } else {
        return DEFAULT_MACHINE_NAME;
    }
}</pre>
                    <li style="list-style: none;" class="nc mono">34: negated conditional : SURVIVED</li>
            </div>

            <div class="step" data-x="4500" data-y="4300" data-rotate-y="90" data-z="-1100">
                <h2>PIT messes with your code (2)</h2>
                <pre class="mono prettyprint lang-java">public String getMachineById(long nodeId) {
    if(nodeId2machine.containsKey(nodeId)) {
        <span class="nb">if(nodeId2machine.get(nodeId) != null) {
    return null;
} else {
    throw new RuntimeException();
}</span>
    } else {
        return DEFAULT_MACHINE_NAME;
    }
}</pre>
                    <li class="nc mono" style="list-style: none;">35: mutated return of Object value /* ... */ : SURVIVED</li>
            </div>

            <div class="step" data-x="4500" data-y="4300" data-rotate-y="90" data-z="-2200">
                <h2>PIT messes with your code (3)</h2>
                <pre class="mono prettyprint lang-java">public String getMachineById(long nodeId) {
    if(nodeId2machine.containsKey(nodeId)) {
        return nodeId2machine.get(nodeId);
    } else {
        <span class="nb">if(DEFAULT_MACHINE_NAME != null) {
    return null;
} else {
    throw new RuntimeException();
}</span>
    }
}</pre>
                <li class="nc mono" style="list-style: none;">37: mutated return of Object value /* ... */ : SURVIVED</li>
            </div>

            <div class="step" data-x="4500" data-y="4900">
                <h2>So we have to write a proper test this time</h2>
                <pre class='mono prettyprint lang-java'>@Test
public void testGetMachineById3() {
    NodeMapper nodeMapper = new NodeMapper(MACHINES);

    Assert.assertEquals(NodeMapper.DEFAULT_MACHINE_NAME, nodeMapper.getMachineById(0));
    Assert.assertEquals(TEST_MACHINE_NAME, nodeMapper.getMachineById(1));
}</pre>
            </div>

            <div class="step" data-x="4500" data-y="5700">
                <pre class="mono console"><span class="prompt">$</span> mvn clean -Dtest=NodeMapperTest#testGetMachineById3 test pitest:mutationCoverage</pre>
                <table data-jmpress="fade">
                    <tr>
                        <td class="line-numbers"><pre class="mono">7



33
<span class="fc">34</span>
<span class="fc">35</span>
36
<span class="fc">37</span>
38
39
40
41</pre></td>
                        <td><pre class="mono prettyprint lang-java">public class NodeMapper {

    //...

    public String getMachineById(long nodeId) {
<span class="fc">        if(nodeId2machine.containsKey(nodeId)) {</span>
<span class="fc">            return nodeId2machine.get(nodeId);</span>
        } else {
<span class="fc">            return DEFAULT_MACHINE_NAME;</span>
        }
    }

}</pre></td>
                    </tr>
                </table>
                <ol class="mutation-list mono">
                    <li class="fc" data-jmpress="fade">34: negated conditional : KILLED</li>
                    <li class="fc" data-jmpress="fade">35: mutated return of Object value /* ... */ : KILLED</li>
                    <li class="fc" data-jmpress="fade">37: mutated return of Object value /* ... */ : KILLED</li>
                </ol>
            </div>

            <div class="step" data-x="4500" data-y="6800">
                <h2>PIT has also found a bug</h2>
                <table>
                    <tr>
                        <td class="line-numbers"><pre class="mono">7

14


<span class="nc">26</span>
27

33
<span class="fc">34</span>
<span class="fc">35</span>
36
<span class="fc">37</span>
38
39
40
41</pre></td>
                        <td><pre class="mono prettyprint lang-java">public class NodeMapper {

    public NodeMapper(Map&lt;~&gt; machines, String defaultMachineName) {
        //...

<span class="nc">        this.defaultMachineName = defaultMachineName;</span>
    }

    public String getMachineById(long nodeId) {
<span class="fc">        if(nodeId2machine.containsKey(nodeId)) {</span>
<span class="fc">            return nodeId2machine.get(nodeId);</span>
        } else {
<span class="fc">            return DEFAULT_MACHINE_NAME;</span> <span data-jmpress="fade">// &lt;-- oops!</span>
        }
    }

}</pre></td>
                    </tr>
                </table>
                <ol class="mutation-list mono">
                    <li class="nc">26: Removed assignment to member variable defaultMachineName : SURVIVED</li>
                </ol>
            </div>

            <!--
            ***********************************
                      UNDER THE HOOD
            ***********************************
            -->

            <div class="step" data-x="6000">
                <h2>Test your stuff in three easy steps</h2>
                <ol class="bigger">
                    <li data-jmpress="fade">Pick stuff to mutate</li>
                    <li data-jmpress="fade">Mutate said stuff</li>
                    <li data-jmpress="fade">Check if stuff fails</li>
                </ol>
            </div>

            <div class="step" data-x="6000" data-y="800">
                <h2>Picking stuff to mutate</h2>
                <ol>
                    <li data-jmpress="fade">Compile the sources to bytecode</li>
                    <li data-jmpress="fade">Run the selected tests</li>
                    <li data-jmpress="fade">Gather detailed Code Coverage info:<br/>
                        which tests execute which instructions</li>
                </ol>
            </div>

            <div class="step" data-x="6000" data-y="1600">
                <h2>Creating mutant overlords</h2>
                <img src="img/genetic-experiments.png" align="left" style="padding-right: 80px;">
                <div>

                    <ol>
                        <li data-jmpress="fade">Use ASM to generate mutations</li>
                        <li data-jmpress="fade">
                            The mutations must be predictable and stable.<br/>
                            The behavior may not change between runs
                        </li>

                        <li data-jmpress="fade">
                            Avoid false positives<br/><br/>
                            <span data-jmpress="fade"><b>Equivalent mutation</b>:
                                a mutation which results in no observable change in behavior</span>
                        </li>

                    </ol>
                </div>
            </div>

            <!-- MUTATORS -->

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90">
                <h2>CONDITIONALS_BOUNDARY<br/>
                    <small class="success">[on by default]</small>
                </h2>
                <p>Changes the inequalities checks from strict to non-strict and vice versa</p>
                <table class="before-after">
                    <tr>
                        <td><p>Before:</p>
                <pre class="mono prettyprint lang-java">if (a &lt; b) {
  // do something
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">if (a <span class="nb">&lt;=</span> b) {
  // do something
}</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-1100">
                <h2>NEGATE_CONDITIONALS
                    <small class="success">[on by default]</small>
                </h2>
                <p>Negates Conditionals</p>
                <table class="before-after">
                    <tr>
                        <td><p>Before:</p>
                <pre class="mono prettyprint lang-java">if (foo()) {
  // do something
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">if (<span class="nb">!</span>foo()) {
  // do something
}</pre>
                        </td>
                    </tr>
                </table>
            </div>
            
	    <div class="step spoiler" style="text-align: center;" data-duration="1200" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-1100">
                <img src="img/giant-nut.jpg"/>
	    </div>

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-2200">
                <h2>MATH
                    <small class="success">[on by default]</small>
                </h2>
                <p>Replaces binary operations by their counterparts</p>
                <table class="before-after">
                    <tr>
                        <td><p>Before:</p>
                            <pre class="mono prettyprint lang-java">int foo = bar + baz;</pre>
                        </td>
                        <td>
                            <p>After:</p>
                            <pre class="mono prettyprint lang-java">int foo = bar <span class="nb">-</span> baz;</pre>
                        </td>
                    </tr>
                </table>
                <p data-jmpress="fade">Also mutates field increments/decrements</p>
                <table>
                    <tr>
                        <td>
                    <pre data-jmpress="fade" class="mono prettyprint lang-java">class Foo {
    private int a;
    //...
    void bar() {
        a++;
    }
}</pre>
                        </td>
                        <td>
                            <span data-jmpress="fade" class="huge">&nbsp;&rarr;&nbsp;</span>
                        </td>
                        <td>
<pre data-jmpress="fade" class="mono prettyprint lang-java">0: aload_0
1: dup
2: getfield
5: iconst_1
6: iadd <span data-jmpress="fade"># &larr; addition</span>
7: putfield
10: return</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-3300">
                <h2>INCREMENTS
                    <small class="success">[on by default]</small>
                </h2>
                <p>
                    Swaps increments to decrements and vice versa<br/>
                </p>
                <table class="before-after">
                    <tr>
                        <td><p>Before:</p>
                            <pre class="mono prettyprint lang-java">counter ++;</pre>
                        </td>
                        <td>
                            <p>After:</p>
                            <pre class="mono prettyprint lang-java">counter <span class="nb">--</span>;</pre>
                        </td>
                    </tr>
                </table>
                <p data-jmpress="fade">
                    NB: only works on local variables
                </p>
            </div>

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-4400">
                <h2>INVERT_NEGS
                    <small class="success">[on by default]</small>
                </h2>
                <p>Removes the unary minus operator</p>
                <table class="before-after">
                    <tr>
                        <td><p>Before:</p>
                            <pre class="mono prettyprint lang-java">int a = -b;</pre>
                        </td>
                        <td>
                            <p>After:</p>
                            <pre class="mono prettyprint lang-java">int a = <span class="nb">b</span>;</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-5500">
                <h2>RETURN_VALS
                    <small class="success">[on by default]</small>
                </h2>
                <p>Changes the value returned by a method</p>
                <table class="before-after">
                    <tr>
                        <td><p>Before:</p>
                <pre class="mono prettyprint lang-java">public int foo() {
    //...
    return true;
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">public int foo() {
    //...
    return <span class="nb">false</span>;
}</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-6600">
                <h2>VOID_METHOD_CALLS
                    <small class="success">[on by default]</small>
                </h2>
                <p>Removes a call to a void method</p>
                <table class="before-after">
                    <tr>
                        <td>
                            <p>Before:</p>
                <pre class="mono prettyprint lang-java">public void foo() {/* ... */ }

public void bar() {
    //...
    foo();
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">public void foo() {/* ... */ }

public void bar() {
    //...
    <span class="nb">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
}</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-7700">
                <h2>INLINE_CONSTS
                    <small class="fail">[off by default]</small>
                </h2>
                <p>Changes literal values assigned to locals</p>
                <table class="before-after">
                    <tr>
                        <td><p>Before:</p>
                <pre class="mono prettyprint lang-java">public int foo() {
    int answer = 42;
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">public int foo() {
    int answer = <span class="nb">43</span>;
}</pre>
                        </td>
                    </tr>
                </table>
                <p data-jmpress="fade">Could spawn lots of RuntimeExceptions</p>
            </div>

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-8800">
                <h2>NON_VOID_METHOD_CALLS<br/>
                    <small class="fail">[off by default]</small>
                </h2>
                <p>Removes a method call, replaces by assigning the default value</p>
                <table class="before-after">
                    <tr>
                        <td>
                            <p>Before:</p>
                <pre class="mono prettyprint lang-java">public String foo() {/* ... */ }

public void bar() {
    //...
    String foo = foo();
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">public String foo() {/* ... */ }

public void bar() {
    //...
    String foo = <span class="nb">null</span>;
}</pre>
                        </td>
                    </tr>
                </table>
                <p data-jmpress="fade">Could spawn lots of NullPointerExceptions and equivalent mutations</p>
            </div>

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-10200">
                <h2>CONSTRUCTOR_CALLS
                    <small class="fail">[off by default]</small>
                </h2>
                <p>Removes a constructor call, to be replaced by assignment of null</p>
                <table class="before-after">
                    <tr>
                        <td>
                            <p>Before:</p>
                <pre class="mono prettyprint lang-java">public void bar() {
    Object foo = new Object();
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">public void bar() {
    Object foo = <span class="nb">null</span>;
}</pre>
                        </td>
                    </tr>
                </table>
                <p data-jmpress="fade">Spawns lots of NullPointerException</p>
            </div>

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-12000">
                <h2>EXPERIMENTAL_INLINE_CONSTS<br/>
                    <small class="fail">[off by default]</small>
                </h2>
                <p>Here to replace INLINE_CONSTS, has more consistent behavior</p>
                <table class="before-after">
                    <tr>
                        <td>
                            <p>Before:</p>
                            <pre class="mono prettyprint lang-java">short s = Byte.MAX_VALUE;</pre>
                        </td>
                        <td>
                            <p>After:</p>
                            <pre class="mono prettyprint lang-java">short s = <span class="nb">Byte.MIN_VALUE</span>;</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-13500">
                <h2>EXPERIMENTAL_MEMBER_VARIABLE<br/>
                    <small class="fail">[off by default]</small>
                </h2>
                <p>Replaces values asigned to fields by default values</p>
                <table class="before-after">
                    <tr>
                        <td>
                            <p>Before:</p>
                <pre class="mono prettyprint lang-java">public class Foo {
    private int magic = 13;
    //...
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">public class Foo {
    private int magic = <span class="nb">0</span>;
    //...
}</pre>
                        </td>
                    </tr>
                </table>
                <p>Could generate lots of equivalent mutations</p>
            </div>

            <div class="step" data-x="6000" data-y="1600" data-rotate-y="90" data-z="-15000">
                <h2>EXPERIMENTAL_SWITCH
                    <small class="fail">[off by default]</small>
                </h2>
                <table class="before-after">
                    <tr>
                        <td>
                            <p>Before:</p>
                <pre class="mono prettyprint lang-java">int a;
//...
switch(a) {
    case 1: doFirst(); break;
    case 2: doSecond(); break;
    default: doDefault(); break;
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">int a;
//...
switch(a) {
    case 1: <span class="nb">doDefault()</span>; break;
    case 2: <span class="nb">doDefault()</span>; break;
    default: <span class="nb">doFirst()</span>; break;
}</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="6000" data-y="2400">
                <h2>Running the analysis</h2>
                <ol>
                    <li data-jmpress="fade">Pick a mutant</li>
                    <li data-jmpress="fade">Use Instrumentation API to replace the original</li>
                    <li data-jmpress="fade">
                        Run the tests until one of them fails (and hence kills the mutant)<br/>
                        <span data-jmpress="fade">Watch out for:</span>
                        <ul>
                            <li data-jmpress="fade after 1ms">Tests working way too long (could have introduced an infinite loop)</li>
                            <li data-jmpress="fade">Out Of Memory errors (could have introduced a memory leak)</li>
                            <li data-jmpress="fade">JVM crashing (you get the idea)</li>
                            <li data-jmpress="fade">Runtime exceptions (not conclusive)</li>
                        </ul>
                    </li>
                </ol>
            </div>

            <div class="step" data-x="6000" data-y="3200">
                <h2>Unit of work is a source class</h2>
                <center><img src="img/balancing.png"/></center>
            </div>

            <!--
            ***********************************
                      SUCCESS STORIES
            ***********************************
            -->

            <div class="step" data-x="9000" style="text-align: center;">
                <h2>The three rules of TDD</h2>
		    <img data-jmpress="fade" src="img/fight-club.jpg" />
            </div>

	    <div class="step" data-x="10100" style="text-align: center;">
                 <h2>The first rule of TDD is</h2>
		 <p class="cool-quote">You do not write any production code<br/>
             Unless it is to make a failing unit test pass</p>
	    </div>

	    <div class="step" data-x="11200" style="text-align: center;">
                 <h2>The second rule of TDD is</h2>
		 <p class="cool-quote">You do not write any more of a unit test than is sufficient to fail<br/>
             <span class="remark">And compilation failures are failures</span></p>
	    </div>

	    <div class="step" data-x="12300" style="text-align: center;">
                 <h2>The third rule of TDD is</h2>
		 <p class="cool-quote">You do not write any production code<br/>
             More than is sufficient to pass the one failing unit test</p>
	    </div>

            <div class="step" data-x="9000" data-y=800>
                <h2>PIT grants you <span class="success">confidence</span> in your tests</h2>
                <p data-jmpress="fade">
                    A success story from TheLadders.com<sup>[4]</sup>
                    <ul>
                        <li data-jmpress="fade">A project from scratch, PIT used from the stard</li>
                        <li data-jmpress="fade">Code and Mutation Coverage of about <span class="success">95%</span></li>
                        <li data-jmpress="fade">Needed to refactor the core to use event sourcing</li>
                        <li data-jmpress="fade">The code was refactored, the tests greened out, and it was rolled out</li>
                        <li data-jmpress="fade">Not a single issue!<sup>*</sup></li>
                    </ul>
                </p>
            </div>


            <!--
            ***********************************
                      TRYING OUT
            ***********************************
            -->

            <div class="step" data-x="7500">
                <h2>Okay, that must be excruciatingly slow!</h2>
                <p>
                    Let's take an allegedly well-covered library and give it a go
                </p>
                <h2 data-jmpress="fade">Apache commons-math</h2>
                <ul>
                    <li data-jmpress="fade">Loads of complex mathematical algorithms</li>
                    <li data-jmpress="fade">177K lines of source code</li>
                    <li data-jmpress="fade">About 5000 tests in 109K lines of code</li>
                </ul>
            </div>

            <div class="step" data-x="7500" data-y="700">
                <pre class="mono console"><span class="prompt">$</span> ./prepare-commons-math3.sh && cd commons-math3

<span data-jmpress="appear">+ svn checkout http://svn.apache.org/repos/asf/commons/proper/math/trunk@1455261 commons-math3</span>
<span data-jmpress="appear after 100ms">A    commons-math3/RELEASE-NOTES.txt</span>
<span data-jmpress="appear after 1s">A    commons-math3/...
 U   commons-math3</span>
<span data-jmpress="appear after 1s">Checked out revision 1455261.</span>

<span data-jmpress="appear">+ patch commons-math3/pom.xml commons-math3-pom-patch.diff</span>
<span data-jmpress="appear after 1s">patching file commons-math3/pom.xml</span></pre>
            </div>

            <div class="step" data-x="7500" data-y="2000">
                <h2>Baseline: good old Code Coverage</h2>
                <pre class="mono console"><span class="prompt">$</span> mvn clean test jacoco:report

<span data-jmpress="appear">...</span>

<span data-jmpress="appear after 300ms">Results :

Tests run: 4901, Failures: 0, Errors: 0, Skipped: 43

[INFO]
[INFO] --- jacoco-maven-plugin:0.6.2.201302030002:report (default-cli) @ commons-math3 ---
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: <span class="nb">7:46.820s</span></span></pre>
                

                <p class="info" data-jmpress="appear">
                    The total Code Coverage is impressive: 92%
                </p>

            </div>
	    
	    <div data-x="7500" data-y="2000" class="step spoiler warn shipilev">
                <img src="img/shipilev.png" align="left"/>
                NB: maven is likely to download quite a few jars the first time it's run<br/>
                Don't forget to exclude that from your stats.
                <br/><br/>
                The rule of thumb is that you should not make bad benchmarks and make good ones instead.
            </div>

            <div class="step" data-x="7500" data-y="3000">
                <h2>Mutation Analysis</h2>
                <pre class="mono console"><span class="prompt">$</span> mvn clean test pitest:mutationCoverage
<span data-jmpress="appear">...</span>
<span data-jmpress="appear after 300ms">================================================================================
- Timings
================================================================================</span>
<span data-jmpress="appear">> scan classpath : < 1 second</span>
<span data-jmpress="appear">> coverage and dependency analysis : <span class="nb">27 minutes and 31 seconds</span></span>
<span data-jmpress="appear">> build mutation tests : 7 seconds</span>
<span data-jmpress="appear">> run mutation analysis : <span class="nb">3 hours, 47 minutes and 7 seconds</span></span>
<span data-jmpress="appear">--------------------------------------------------------------------------------
> Total  : <span class="nb">4 hours, 14 minutes and 46 seconds</span></span></pre>

                <p class="info" data-jmpress="appear">
                    The total Mutation Coverage is 79%
                </p>

            </div>

            <div class="step spoiler" data-x="7500" data-y="3000" style='text-align: center;'>
                <img src="img/slowpoke.png"/>
            </div>

            <div class="step" data-x="7500" data-y="4000">
                <h2>We could throw in more threads</h2>
                <pre class="mono console"><span class="prompt">$</span> mvn clean test pitest:mutationCoverage <span class="nb">-Dpit.threads=2</span>
<span data-jmpress="appear">...</span>
<span data-jmpress="appear after 300ms">================================================================================
- Timings
================================================================================</span>
<span data-jmpress="appear">> scan classpath : < 1 second</span>
<span data-jmpress="appear">> coverage and dependency analysis : <span class="nb">27 minutes and 28 seconds</span></span>
<span data-jmpress="appear">> build mutation tests : 3 seconds</span>
<span data-jmpress="appear">> run mutation analysis : <span class="nb">2 hours, 2 minutes and 1 seconds</span></span>
<span data-jmpress="appear">--------------------------------------------------------------------------------
> Total  : <span class="nb">2 hours, 29 minutes and 33 seconds</span></span></pre>
                <p class="info" data-jmpress="appear">
                    The improvement is nearly linear
                </p>

            </div>

            <div class="step graph" data-x="7500" data-y="4000" data-rotate-y="90">
                <img src="img/performance-graph-commons-math3.png"/>
            </div>

            <div class="step graph" data-x="7500" data-y="4000" data-rotate-y="90" data-z="-1500">
                <h2>CPU load over time</h2>
                <img src="img/core-load.png"/>
            </div>

            <div class="step graph" data-x="7500" data-y="4000" data-rotate-y="90" data-z="-3000">
                <h2>CPU load over time</h2>
                <img src="img/core-load-explained.png"/>
            </div>

            <div class="step graph" data-x="7500" data-y="4000" data-rotate-y="90" data-z="-4500">
                <h2>Improved in pitest 0.30</h2>
                <img src="img/core-load-improved.png"/>
            </div>

            <div class="step graph" data-x="7500" data-y="4000" data-rotate-y="90" data-z="-6000">
                <h2>Improved further in pitest 0.31</h2>
                <img src="img/core-load-improved-more.png"/>
            </div>

            <div class="step graph" data-x="7500" data-y="4000" data-rotate-y="90" data-z="-7500">
                <img src="img/performance-comparison.png"/>
	    </div>

            <div class="step" data-x="7500" data-y="5300">
                <h2>Incremental analysis</h2>
                <h3 data-jmpress="fade">Some metadata is stored in-between runs</h3>
                <ul>
                    <li data-jmpress="fade">The hashes of all tested classes</li>
                    <li data-jmpress="fade">The hashes of all the tests</li>
                    <li data-jmpress="fade">Analysis results</li>
                </ul>
            </div>

            <div class="step" data-x="7500" data-y="6000">
                <h3>During each following run, some heuristics are applied.<br/>
                A mutant will not be checked again, if the last time it:</h3>
                <ul>
                    <li data-jmpress="fade"><font color="#00008b">timed out</font>, and the class has not changed</li>
                    <li data-jmpress="fade">was <font color="#008b00">killed</font>, and neither the class nor the test have changed</li>
                    <li data-jmpress="fade"><font color="#8b0000">survived</font>, and there are no new/changed tests for it</li>
                </ul>
            </div>

            <div class="step" data-x="7500" data-y="6700">
                <h3>Okay, what of the dependencies?</h3>
                <p data-jmpress="fade">
                    PIT only considers the changed make to superclasses or outer classes <span class="remark">(if any)</span><br/><br/>
                    <span data-jmpress="fade">It does not take into account changes made to dependencies</span>
                </p>
            </div>

            <div class="step" data-x="7500" data-y="7600">
                <h2>Overhead induced by incremental analysis</h2>
                <pre class="mono console"><span class="prompt">$</span> mvn clean test pitest:mutationCoverage <span class="nb">-P pit-history</span> -Dpit.threads=4

<span data-jmpress="fade">...
================================================================================
- Timings
================================================================================
> scan classpath : < 1 second
> coverage and dependency analysis : <span class="nb">7 minutes and 15 seconds</span>
> build mutation tests : 2 seconds
> run mutation analysis : <span class="nb">55 minutes and 41 seconds</span>
--------------------------------------------------------------------------------
> Total  : <span class="nb">1 hours, 2 minutes and 59 seconds</span></span></pre>

                <p class="info" data-jmpress="fade">
                    Meta-info is saved nearly for free
                </p>
            </div>

            <div class="step" data-x="7500" data-y="7600" data-rotate-y="90">
                <h2>PIT has found some useless code!</h2>
                <table style="padding-top: 1px; margin-top: -60px;">
                    <tr>
                        <td class="line-numbers"><pre class="mono">


193
194
<span class="fc">195
196
197
198
199</span>
<span class="nc" data-jmpress="become-green">200</span>
<span class="fc">201
202
203</span>
<span data-jmpress="disappear after 1ms">204</span></pre></td>
                        <td><pre class="mono prettyprint lang-java">// In org.apache.commons.math3.linear.MatrixUtils

public static &lt;T extends FieldElement&lt;T&gt;&gt; FieldMatrix&lt;T&gt;
createFieldIdentityMatrix(final Field&lt;T&gt; field, final int dimension) {
<span class="fc">    final T zero = field.getZero();
    final T one  = field.getOne();
    final T[][] d = MathArrays.buildArray(field, dimension, dimension);
    for (int row = 0; row < dimension; row++) {
        final T[] dRow = d[row];</span><span class="nc" data-jmpress="disappear after 1ms">
        Arrays.fill(dRow, zero);</span>
<span class="fc">        dRow[row] = one;
    }
    return new Array2DRowFieldMatrix&lt;T&gt;(field, d, false);</span>
}</pre></td>
                    </tr>
                </table>
                <h3>Mutations</h3>
                <ol class="mutation-list mono">
                    <li class="nc">200: removed call to java/util/Arrays::fill : SURVIVED</li>
                </ol>
            </div>

            <div class="step" data-x="7500" data-y="7600" data-rotate-y="90" data-z="-1500">
                <h2>Let's run the tests on the updated code base</h2>
                <pre class="mono console"><span class="prompt">$</span> mvn clean test pitest:mutationCoverage <span class="nb">-P pit-history</span> -Dpit.threads=24

<span data-jmpress="fade">...
================================================================================
- Timings
================================================================================
> scan classpath : < 1 second</span>
<span data-jmpress="fade">> coverage and dependency analysis : <span class="nb">7 minutes and 3 seconds</span>
> build mutation tests : 1 minutes and 1 seconds</span>
<span data-jmpress="fade">> run mutation analysis : <span class="nb">56 seconds</span></span>
<span data-jmpress="fade">--------------------------------------------------------------------------------
> Total  : <span class="nb">9 minutes and 0 seconds</span>
--------------------------------------------------------------------------------</span></pre>
            </div>

            <div class="step" data-x="7500" data-y="8600">
                <h2>The elapsed time is negligible on simpler projects</h2>
                <p data-jmpress="fade"><b>Joda Time</b> &dash; an awesome library that lets youwork with dates and times</p>
                <ul>
                    <li data-jmpress="fade">68K lines of code</li>
                    <li data-jmpress="fade">70K lines of test code</li>
                    <li data-jmpress="fade" style="list-style: none;"><h2>Mutation analysis is done in under 7 minutes</h2></li>
                </ul>
            </div>

            <!-- GRAIN OF SALT -->

            <div class="step" data-x="10500" data-y="0">
                <center><img src="img/excited.jpg"/></center>
            </div>

            <div class="step" data-x="10500" data-y="1000">
                <center>
                    <h2>Probably, there's nothing perfect in existence</h2>
                </center>
            </div>

            <div class="step" data-x="10500" data-y="1500">
                <h3>PIT is not perfect either</h3>
                <p>
                    <pre class='mono prettyprint lang-java'>public int evaluate(final int distance) {
    if(distance == 0) {
        throw new IllegalArgumentException("Distance should be non-zero");
    }

    int result = 0;

    if(distance > 0) {
        result += calculateDistanceAdjustment(distance);
    }

    return result;
}</pre>
                </p>
            </div>

            <div class="step" data-x="10500" data-y="2500">
                <h2>PIT vs Defensive Programming</h2>
                <table style="padding-top: 1px; margin-top: -60px;">
                    <tr>
                        <td class="line-numbers"><pre class="mono">5
<span class="fc">6
7</span>
8
9
<span class="fc">10</span>
11
<span class="nc">12</span>
<span class="fc">13</span>
14
15
<span class="fc">16</span>
17</pre></td>
                        <td><pre class="mono prettyprint lang-java">public int evaluate(final int distance) {
<span class="fc">    if(distance == 0) {
        throw new IllegalArgumentException("Distance should be non-zero");</span>
    }

<span class="fc">    int result = 0;</span>

<span class="nc">    if(distance > 0) {</span>
<span class="fc">        result += calculateDistanceAdjustment(distance);</span>
    }

<span class="fc">    return result;</span>
}</pre></td>
                    </tr>
                </table>
                <h3>Mutations</h3>
                <ol class="mutation-list mono">
                    <li class="nc">12: changed conditional boundary â†’ SURVIVED</li>
                </ol>
            </div>

            <div class="step" data-x="10500" data-y="4000">
                <h2>PIT vs Dangerous Code</h2>
                <p>
                    <pre class='mono prettyprint lang-java'>public static void rectify(String path) {
    ensurePathIsSecure(path);

    rmRf(path);
}

private static final void rmRf(String path) {
    System.out.println("$ rm -rf " + path);
    // Actually remove the directory
}</pre>
                </p>
            </div>

            <div class="step" data-x="10500" data-y="5500">
                <h2>I accidentally your data</h2>
                <pre class="mono">
stderr  : PIT >> Running mutation  <span class="remark">[...]</span>
          mutator=VoidMethodCallMutator,
          description=<span class="fail">removed call to Minitrue::ensurePathIsSecure</span>
          <span data-jmpress="fade">testsInOrder=[<span class="fail">MinitrueTest.testRectifySecurity</span> <span class="remark">[...]</span>]</span>
<span class="remark" data-jmpress="fade">stderr  : PIT >> mutating method rectify
stderr  : PIT >> 2 relevant test for rectify
stderr  : PIT >> replaced class with mutant in 2 ms
stderr  : PIT >> Running 1 units</span>
<span class="fail" data-jmpress="fade">stdout  : $ rm -rf /</span></pre>
            </div>

            <div class="step" id="reading-material" data-x="1100" data-y="800">
                <h2>Reading material</h2>
                <ol>
                    <li>Mutation Analysis [1979]: Budd, Lipton, DeNillo, Sayward<br/>
                        <a href="http://www.cs.yale.edu/publications/techreports/tr155.pdf">
                            http://www.cs.yale.edu/publications/techreports/tr155.pdf
                        </a>
                    </li>
                    <li>
                        Detailed comparison of java mutation testing frameworks<br/>
                        <a href="http://pitest.org/java_mutation_testing_systems">
                            http://pitest.org/java_mutation_testing_systems
                        </a>
                    </li>
                    <li>
                        The three laws of TDD <br/>
                        <a href="http://butunclebob.com/ArticleS.UncleBob.TheThreeRulesOfTdd">
                            http://butunclebob.com/ArticleS.UncleBob.TheThreeRulesOfTdd
                        </a>
                    </li>
                    <li>
                        Mutation Testing With PIT: A Step Beyond Normal Code Coverage<br/>
                        <a href="http://dev.theladders.com/2013/02/mutation-testing-with-pit-a-step-beyond-normal-code-coverage/">
                            http://dev.theladders.com/2013/02/mutation-testing-with-pit-a-step-beyond-normal-code-coverage/
                        </a>
                    </li>
                </ol>
            </div>

            <div class="step" id="try-me" data-x="1100" data-y="1600">
                <h2>Do It Yourself</h2>
                <pre class="console mono">$ git clone git@github.com:gvsmirnov/docs.git
$ cd docs/presentations/java-mutation-testing</pre>
                <h2>See this presentation again</h2>
                <p><a href="http://gvsmirnov.ru/docs/presentations/java-mutation-testing/">http://gvsmirnov.ru/docs/presentations/java-mutation-testing/</a><br/>
                    <small class="remark">Is sure to work in Webkit-based browsers on Mac OS, may have issues on other browsers/platforms</small>
                </p>
            </div>

	    <div class="step graph" id="qr" data-x="1100" data-y="2600">
                <img src="img/qr.png" style="height: 600px; width: auto;"/>
	    </div>

            <div id="overview" class="step" data-x="3000" data-y="1500" data-scale="10"></div>
        </div>

        <script type="text/javascript">
            $(function() {
                    $('#impress').jmpress({
                        "mouse": { clickSelects: false },
                        "beforeChange": function(element, eventData) {
                            element = $(element);
                            if(element.is('tr')) {
                                element.addClass('visited'); // code should not be hidden after visiting
                            }
                        }
                    });
            });

            prettyPrint();
        </script>
    </body>
</html>




