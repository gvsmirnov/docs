<!doctype html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
    <head>
        <meta charset="utf-8" />

        <title>Java mutation testing</title>

        <link href="css/impress.css" rel="stylesheet"/>
        <link href="css/prettify.css" rel="stylesheet"/>
        <link href="css/animation.css" rel="stylesheet"/>

        <script src="js/jquery.min.js"></script>
        <script src="js/jmpress.impress.js"></script>
        <script src="js/prettify.js"></script>

    </head>

    <body>
        <div id="impress">
            <div class="step slide" style="text-align: center;">
                <img src="img/yandex_eng_logo.png" alt="Yandex" style="margin-top: 100px;"/>
            </div>

            <div class="step slide" data-x="1100" style="text-align: center;">
                <h1>Mutation Testing</h1>
                <h2>or what Code Coverage doesn't tell us</h2>
                <br/>
                <br/>
                <br/>
                <br/>
                <br/>
                <br/>
                <br/>
                <small>Gleb Smirnov<br /><a href="mailto:me@gvsmirnov.ru">me@gvsmirnov.ru</a></small>
            </div>

            <!--
            ***********************************
                       CODE COVERAGE
            ***********************************
            -->

            <div class="step" data-x="2200">
                <h2>People have noticed that tests can be broken</h2>
                <pre class='mono prettyprint lang-java'>public class NodeMapperTest {

    @Test
    public void testGetMachineById() {
        // The boss says we should write tests, but it has worked
        // just fine up until now, and I have *important* things to do

        Assert.assertTrue(true);
    }

}</pre>
            </div>

            <div class="step" data-x="2200" data-y="800">
                <h2>So they invented Code Coverage</h2>
                <pre class="mono console"><span class="prompt">src$</span> mvn clean -Dtest=NodeMapperTest#testGetMachineById test jacoco:report</pre>

                <pre class="mono prettyprint lang-java" data-jmpress="fade">
public class NodeMapper {

    //...

    public String getMachineById(long nodeId) {
<span class="nc">        if(nodeId2machine.containsKey(nodeId)) {</span>
<span class="nc">            return nodeId2machine.get(nodeId);</span>
        } else {
<span class="nc">            return DEFAULT_MACHINE_NAME;</span>
        }
    }

}
</pre>
            </div>

            <div class="step" data-x="2200" data-y="1600">
                <h2>But the broken tests didn't stop being broken</h2>
                <pre class='mono prettyprint lang-java'>private static final Map&lt;String, List&lt;Long&gt;&gt; MACHINES = /* ... */

@Test
public void testGetMachineById2() {
    NodeMapper nodeMapper = new NodeMapper(MACHINES);

    nodeMapper.getMachineById(0);
    nodeMapper.getMachineById(1);
}</pre>
            </div>

            <div class="step" data-x="2200" data-y="2400">
                <h2>While Code Coverage reported that it was OK</h2>
                <pre class="mono console"><span class="prompt">src$</span> mvn clean -Dtest=NodeMapperTest#testGetMachineById2 test jacoco:report</pre>
                <pre class="mono prettyprint lang-java" data-jmpress="fade">
public class NodeMapper {

    //...

    public String getMachineById(long nodeId) {
<span class="fc bfc">        if(nodeId2machine.containsKey(nodeId)) {</span>
<span class="fc">            return nodeId2machine.get(nodeId);</span>
        } else {
<span class="fc">            return DEFAULT_MACHINE_NAME;</span>
        }
    }

}
</pre>
                <h3 class="mono success" data-jmpress="fade after 5ms">&gt; Code coverage: 100%</h3>
            </div>

            <!--
            ***********************************
                     MUTATION TESTING
            ***********************************
            -->

            <div class="step" data-x="3300">
                <h2>So people invented Mutation Testing</h2>
                <ol>
                    <li data-jmpress="fade">Run the tests</li>
                    <li data-jmpress="fade">Randomly change some code</li>
                    <li data-jmpress="fade">Run the tests again</li>
                    <li data-jmpress="fade">Expect the tests to fail</li>
                </ol>
                <h3 data-jmpress="fade">If a changed instruction doesn't cause any test to fail,<br/>
                    the instruction is likely not tested properly</h3>
            </div>

            <div class="step" data-x="3300" data-y="800">
                <h2>In fact, they invented it a long time ago</h2>
                <p>
                    <ul>
                        <li data-jmpress="fade">Richard Lipton proposes the idea in 1971</li>
                        <li data-jmpress="fade">
                            Timothy Budd implements the first<br/>
                            mutation testing tool for FORTRAN in 1979<sup>[1]</sup>
                        </li>
                        <li style="margin-top: 20pt; list-style-type: none; color: #a9a9a9;" data-jmpress="fade">
                            ... Nearly 30 years pass ...
                        </li>
                        <li style="margin-top: 20pt;" data-jmpress="fade">
                            People are finally starting to use it in production
                        </li>
                    </ul>
                </p>
            </div>

            <div class="step" data-x="3300" data-y="1600">
                <h2>Usable mutation testing libraries are few</h2>
                <p>
                <ul>
                    <li>Javalanche</li>
                    <li>Jumble</li>
                    <li>Jester</li>
                    <li>Simple Jester</li>
                </ul>
                <div class="step spoiler" data-y="250">
                    <h3>
                        All of these are <span class="fail">not</span> usable,
                        as they are <small class="remark">at least one of</small>
                    </h3>
                    <ul>
                        <li>Abandoned</li>
                        <li>Outdated</li>
                        <li>Very slow</li>
                        <li>Barely support any frameworks</li>
                    </ul>
                </div>
                </p>
            </div>

            <div class="step" data-x="3300" data-y="2400">
                <h2>But PIT saves the day</h2>
                <p>
                    <ul>
                        <li data-jmpress="fade">Actively developed</li>
                        <li data-jmpress="fade">Performance is acceptable</li>
                        <li data-jmpress="fade">Open source</li>
                        <li data-jmpress="fade">Supports Java 7, Maven, JUnit, *Mock*, ...</li>
                    </ul>
                </p>
            </div>

            <div class="step" data-x="3300" data-y="3200">
                <h2>Comparison table<sup>[2]</sup></h2>
                <p>
                    <img src="img/mutation-comparison.png"/>
                </p>
                <ul>
                    <li><strong>Y</strong>- supported out of the box</li>
                    <li>N - no support</li>
                    <li>! - supported but with issues reported</li>
                    <li>3rd - supported via 3rd party component</li>
                    <li>? - donâ€™t know</li>
                </ul>
            </div>

            <div class="step" data-x="3300" data-y="3600">
                <h1 class="success">Pitest rocks!</h1>
            </div>

            <div class="step" data-x="3300" data-y="4100">
                <h2>And it <span class="success">does</span> detect the broken test</h2>
                <pre class="mono console"><span class="prompt">src$</span> mvn clean -Dtest=NodeMapperTest#testGetMachineById2 test pitest:mutationCoverage</pre>
                <table data-jmpress="fade">
                    <tr>
                        <td class="line-numbers"><pre class="mono">7



33
<span class="nc">34</span>
<span class="nc">35</span>
36
<span class="nc">37</span>
38
39
40
41</pre></td>
                        <td><pre class="mono prettyprint lang-java">public class NodeMapper {

    //...

    public String getMachineById(long nodeId) {
<span class="nc">        if(nodeId2machine.containsKey(nodeId)) {</span>
<span class="nc">            return nodeId2machine.get(nodeId);</span>
        } else {
<span class="nc">            return DEFAULT_MACHINE_NAME;</span>
        }
    }

}</pre></td>
                    </tr>
                </table>
                <h3 data-jmpress="fade">Mutations</h3>
                <ol class="mutation-list mono">
                    <li class="nc" data-jmpress="fade after 1ms">34: negated conditional : SURVIVED</li>
                    <li class="nc" data-jmpress="fade">35: mutated return of Object value /* ... */ : SURVIVED</li>
                    <li class="nc" data-jmpress="fade">37: mutated return of Object value /* ... */ : SURVIVED</li>
                </ol>
            </div>

            <div class="step" data-x="3300" data-y="4100" data-rotate-y="90">
                <h2>PIT has introduced the following mutations (1)</h2>
                <pre class="mono prettyprint lang-java">public String getMachineById(long nodeId) {
    if(<span class="nb">!</span>nodeId2machine.containsKey(nodeId)) {
        return nodeId2machine.get(nodeId);
    } else {
        return DEFAULT_MACHINE_NAME;
    }
}</pre>
            </div>

            <div class="step" data-x="3300" data-y="4100" data-rotate-y="90" data-z="-1100">
                <h2>PIT has introduced the following mutations (2)</h2>
                <pre class="mono prettyprint lang-java">public String getMachineById(long nodeId) {
    if(nodeId2machine.containsKey(nodeId)) {
        <span class="nb">if(nodeId2machine.get(nodeId) != null) {
    return null;
} else {
    throw new RuntimeException();
}</span>
    } else {
        return DEFAULT_MACHINE_NAME;
    }
}</pre>
            </div>

            <div class="step" data-x="3300" data-y="4100" data-rotate-y="90" data-z="-2200">
                <h2>PIT has introduced the following mutations (3)</h2>
                <pre class="mono prettyprint lang-java">public String getMachineById(long nodeId) {
    if(nodeId2machine.containsKey(nodeId)) {
        return nodeId2machine.get(nodeId);
    } else {
        <span class="nb">if(DEFAULT_MACHINE_NAME != null) {
    return null;
} else {
    throw new RuntimeException();
}</span>
    }
}</pre>
            </div>

            <div class="step" data-x="3300" data-y="4900">
                <h2>To pass the testing, we have to write a proper test</h2>
                <pre class='mono prettyprint lang-java'>@Test
public void testGetMachineById3() {
    NodeMapper nodeMapper = new NodeMapper(MACHINES);

    Assert.assertEquals(NodeMapper.DEFAULT_MACHINE_NAME, nodeMapper.getMachineById(0));
    Assert.assertEquals(TEST_MACHINE_NAME, nodeMapper.getMachineById(1));
}</pre>
            </div>

            <div class="step" data-x="3300" data-y="5700">
                <h2>And finally rejoice!</h2>
                <pre class="mono console"><span class="prompt">src$</span> mvn clean -Dtest=NodeMapperTest#testGetMachineById3 test pitest:mutationCoverage</pre>
                <table data-jmpress="fade">
                    <tr>
                        <td class="line-numbers"><pre class="mono">7



33
<span class="fc">34</span>
<span class="fc">35</span>
36
<span class="fc">37</span>
38
39
40
41</pre></td>
                        <td><pre class="mono prettyprint lang-java">public class NodeMapper {

    //...

    public String getMachineById(long nodeId) {
<span class="fc">        if(nodeId2machine.containsKey(nodeId)) {</span>
<span class="fc">            return nodeId2machine.get(nodeId);</span>
        } else {
<span class="fc">            return DEFAULT_MACHINE_NAME;</span>
        }
    }

}</pre></td>
                    </tr>
                </table>
                <h3 data-jmpress="fade">Mutations</h3>
                <ol class="mutation-list mono">
                    <li class="fc" data-jmpress="fade after 1ms">34: negated conditional : KILLED</li>
                    <li class="fc" data-jmpress="fade">35: mutated return of Object value /* ... */ : KILLED</li>
                    <li class="fc" data-jmpress="fade">37: mutated return of Object value /* ... */ : KILLED</li>
                </ol>
            </div>

            <div class="step" data-x="3300" data-y="6500">
                <h2>PIT has also found a bug</h2>
                <table>
                    <tr>
                        <td class="line-numbers"><pre class="mono">7

14


<span class="nc">26</span>
27

33
<span class="fc">34</span>
<span class="fc">35</span>
36
<span class="fc">37</span>
38
39
40
41</pre></td>
                        <td><pre class="mono prettyprint lang-java">public class NodeMapper {

    public NodeMapper(Map&lt;~&gt; machines, String defaultMachineName) {
        //...

<span class="nc">        this.defaultMachineName = defaultMachineName;</span>
    }

    public String getMachineById(long nodeId) {
<span class="fc">        if(nodeId2machine.containsKey(nodeId)) {</span>
<span class="fc">            return nodeId2machine.get(nodeId);</span>
        } else {
<span class="fc">            return DEFAULT_MACHINE_NAME;</span> <span data-jmpress="fade">// &lt;-- oops!</span>
        }
    }

}</pre></td>
                    </tr>
                </table>
                <h3>Mutations</h3>
                <ol class="mutation-list mono">
                    <li class="nc">26: Removed assignment to member variable defaultMachineName : SURVIVED</li>
                </ol>
            </div>

            <!--
            ***********************************
                      UNDER THE HOOD
            ***********************************
            -->

            <div class="step" data-x="4400">
                <h2>Test your tests in three easy steps</h2>
                <ol>
                    <li data-jmpress="fade">Choose stuff to mutate</li>
                    <li data-jmpress="fade">Mutate stuff</li>
                    <li data-jmpress="fade">Check if stuff fails</li>
                </ol>
            </div>

            <div class="step" data-x="4400" data-y="800">
                <h2>Choosing what to mutate</h2>
                <ol>
                    <li data-jmpress="fade">Compile the sources to bytecode</li>
                    <li data-jmpress="fade">Run the desired tests with code coverage</li>
                    <li data-jmpress="fade">See which tests execute which instructions</li>
                </ol>
            </div>

            <div class="step" data-x="4400" data-y="1600">
                <h2>Actually applying mutations</h2>
                <ol>
                    <li data-jmpress="fade">Generate the mutated classes (ASM) and store them in memory</li>
                    <li data-jmpress="fade">
                        Use the instrumentation API to insert them at runtime
                        <ul>
                            <li class="fail" data-jmpress="fade">Doesn't work with static initializers</li>
                            <li class="fail" data-jmpress="fade">Requires a JVM with instrumentation support</li>
                            <li class="success" data-jmpress="fade">Works fast</li>
                        </ul>
                    </li>
                </ol>
            </div>

            <div class="step" data-x="4400" data-y="2400">
                <h2>Run the tests and generate reports</h2>
                <ol>
                    <li data-jmpress="fade">Split all test cases into separate suits</li>
                    <li data-jmpress="fade">Pick a mutant that should be checked</li>
                    <li data-jmpress="fade">
                        Run the tests until one of them fails (and kills the mutant)<br/>
                        <span data-jmpress="fade">Look out for:</span>
                        <ul>
                            <li data-jmpress="fade after 1ms">Tests timing out (an infinite loop has been introduces)</li>
                            <li data-jmpress="fade">OOM exceptions (a memory leak has been introduced)</li>
                            <li data-jmpress="fade">Validation errors (the generated bytecode was faulty)</li>
                            <li data-jmpress="fade">Runtime exceptions</li>
                        </ul>
                    </li>
                </ol>
            </div>

            <div class="step" data-x="4400" data-y="3200">
                <h2>There are 13 various mutations available</h2>
            </div>

            <div class="step" data-x="4400" data-y="3200" data-rotate-y="90">
                <h2>CONDITIONALS_BOUNDARY
                    <small class="success">[on by default]</small>
                </h2>
                <table class="before-after">
                    <tr>
                        <td><p>Before:</p>
                <pre class="mono prettyprint lang-java">if (a &lt; b) {
  // do something
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">if (a <span class="nb">&lt;=</span> b) {
  // do something
}</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="4400" data-y="3200" data-rotate-y="90" data-z="-1100">
                <h2>NEGATE_CONDITIONALS
                    <small class="success">[on by default]</small>
                </h2>
                <table class="before-after">
                    <tr>
                        <td><p>Before:</p>
                <pre class="mono prettyprint lang-java">if (foo()) {
  // do something
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">if (<span class="nb">!</span>foo()) {
  // do something
}</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="4400" data-y="3200" data-rotate-y="90" data-z="-2200">
                <h2>MATH
                    <small class="success">[on by default]</small>
                </h2>
                <table class="before-after">
                    <tr>
                        <td><p>Before:</p>
                            <pre class="mono prettyprint lang-java">int foo = bar + baz;</pre>
                        </td>
                        <td>
                            <p>After:</p>
                            <pre class="mono prettyprint lang-java">int foo = bar <span class="nb">-</span> baz;</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="4400" data-y="3200" data-rotate-y="90" data-z="-3300">
                <h2>INCREMENTS
                    <small class="success">[on by default]</small>
                </h2>
                <table class="before-after">
                    <tr>
                        <td><p>Before:</p>
                            <pre class="mono prettyprint lang-java">counter ++;</pre>
                        </td>
                        <td>
                            <p>After:</p>
                            <pre class="mono prettyprint lang-java">counter <span class="nb">--</span>;</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="4400" data-y="3200" data-rotate-y="90" data-z="-4400">
                <h2>INVERT_NEGS
                    <small class="success">[on by default]</small>
                </h2>
                <table class="before-after">
                    <tr>
                        <td><p>Before:</p>
                            <pre class="mono prettyprint lang-java">int a = -b;</pre>
                        </td>
                        <td>
                            <p>After:</p>
                            <pre class="mono prettyprint lang-java">int a = <span class="nb">b</span>;</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="4400" data-y="3200" data-rotate-y="90" data-z="-5500">
                <h2>RETURN_VALS
                    <small class="success">[on by default]</small>
                </h2>
                <table class="before-after">
                    <tr>
                        <td><p>Before:</p>
                <pre class="mono prettyprint lang-java">public int foo() {
    //...
    return true;
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">public int foo() {
    //...
    return <span class="nb">false</span>;
}</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="4400" data-y="3200" data-rotate-y="90" data-z="-6600">
                <h2>VOID_METHOD_CALLS
                    <small class="success">[on by default]</small>
                </h2>
                <table class="before-after">
                    <tr>
                        <td>
                            <p>Before:</p>
                <pre class="mono prettyprint lang-java">public void foo() {/* ... */ }

public void bar() {
    //...
    foo();
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">public void foo() {/* ... */ }

public void bar() {
    //...
    <span class="nb">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
}</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="4400" data-y="3200" data-rotate-y="90" data-z="-7700">
                <h2>INLINE_CONSTS
                    <small class="fail">[off by default]</small>
                </h2>
                <table class="before-after">
                    <tr>
                        <td><p>Before:</p>
                <pre class="mono prettyprint lang-java">public int foo() {
    int answer = 42;
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">public int foo() {
    int answer = <span class="nb">43</span>;
}</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="4400" data-y="3200" data-rotate-y="90" data-z="-8800">
                <h2>NON_VOID_METHOD_CALLS
                    <small class="fail">[off by default]</small>
                </h2>
                <table class="before-after">
                    <tr>
                        <td>
                            <p>Before:</p>
                <pre class="mono prettyprint lang-java">public String foo() {/* ... */ }

public void bar() {
    //...
    String foo = foo();
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">public String foo() {/* ... */ }

public void bar() {
    //...
    String foo = <span class="nb">null</span>;
}</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="4400" data-y="3200" data-rotate-y="90" data-z="-9900">
                <h2>CONSTRUCTOR_CALLS
                    <small class="fail">[off by default]</small>
                </h2>
                <table class="before-after">
                    <tr>
                        <td>
                            <p>Before:</p>
                <pre class="mono prettyprint lang-java">public void bar() {
    Object foo = new Object();
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">public void bar() {
    Object foo = <span class="nb">null</span>;
}</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="4400" data-y="3200" data-rotate-y="90" data-z="-11000">
                <h2>EXPERIMENTAL_INLINE_CONSTS
                    <small class="fail">[off by default]</small>
                </h2>
                <table class="before-after">
                    <tr>
                        <td>
                            <p>Before:</p>
                <pre class="mono prettyprint lang-java">short s = Byte.MAX_VALUE;</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">short s = <span class="nb">Byte.MIN_VALUE</span>;</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="4400" data-y="3200" data-rotate-y="90" data-z="-12100">
                <h2>EXPERIMENTAL_MEMBER_VARIABLE
                    <small class="fail">[off by default]</small>
                </h2>
                <table class="before-after">
                    <tr>
                        <td>
                            <p>Before:</p>
                <pre class="mono prettyprint lang-java">public class Foo {
    private int magic = 13;
    //...
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">public class Foo {
    private int magic = <span class="nb">0</span>;
    //...
}</pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="4400" data-y="3200" data-rotate-y="90" data-z="-13200">
                <h2>EXPERIMENTAL_SWITCH
                    <small class="fail">[off by default]</small>
                </h2>
                <table class="before-after">
                    <tr>
                        <td>
                            <p>Before:</p>
                <pre class="mono prettyprint lang-java">int a;
//...
switch(a) {
    case 1: doFirst(); break;
    case 2: doSecond(); break;
    default: doDefault(); break;
}</pre>
                        </td>
                        <td>
                            <p>After:</p>
                <pre class="mono prettyprint lang-java">int a;
//...
switch(a) {
    case 1: <span class="nb">doDefault()</span>; break;
    case 2: <span class="nb">doDefault()</span>; break;
    default: <span class="nb">doFirst()</span>; break;
}</pre>
                        </td>
                    </tr>
                </table>
            </div>


            <!--
            ***********************************
                      TRYING OUT
            ***********************************
            -->

            <div class="step" data-x="5500">
                <h2>That's a lot of stuff to do, shouldn't it take ages?</h2>
                <p>
                    Take a well-tested library and see how long mutation testing runs
                </p>
                <pre class="mono console"><span class="prompt">$</span> ./prepare-commons-math3.sh

<span data-jmpress="appear">+ svn checkout http://svn.apache.org/repos/asf/commons/proper/math/trunk@1455261 commons-math3</span>
<span data-jmpress="appear after 100ms">A    commons-math3/RELEASE-NOTES.txt</span>
<span data-jmpress="appear after 1s">A    commons-math3/...
 U   commons-math3</span>
<span data-jmpress="appear after 1s">Checked out revision 1455261.</span>

<span data-jmpress="appear">+ patch commons-math3/pom.xml commons-math3-pom-patch.diff</span>
<span data-jmpress="appear after 1s">patching file commons-math3/pom.xml</span></pre>
            </div>

            <div class="step" data-x="5500" data-y="800">
                <h2>As a baseline, measure how long JUnit runs</h2>
                <pre class="mono console"><span class="prompt">commons-math3$</span> mvn clean test

<span data-jmpress="appear">...</span>

<span data-jmpress="appear after 300ms">Results :

Tests run: 4901, Failures: 0, Errors: 0, Skipped: 43

[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: <span class="nb">5:32.174s</span></span></pre>
                <p data-jmpress="fade" class="warn">
                    NB: maven is likely to spend a lot of time downloading jars
                    when you first run it
                    <br/><br/>
                    Make sure you measure the elapsed time at least twice
                </p>

            </div>

            <div class="step" data-x="5500" data-y="1600">
                <h2>Then, see how long code coverage runs</h2>
                <pre class="mono console"><span class="prompt">commons-math3$</span> mvn clean test jacoco:report

<span data-jmpress="appear">...</span>

<span data-jmpress="appear after 300ms">Results :

Tests run: 4901, Failures: 0, Errors: 0, Skipped: 43

[INFO]
[INFO] --- jacoco-maven-plugin:0.6.2.201302030002:report (default-cli) @ commons-math3 ---
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: <span class="nb">5:40.120s</span></span></pre>

                <p class="info" data-jmpress="appear">
                    The total code coverage is 92%
                </p>

            </div>

            <div class="step" data-x="5500" data-y="2400">
                <h2>Finally, run mutation coverage</h2>
                <pre class="mono console"><span class="prompt">commons-math3$</span> mvn clean test pitest:mutationCoverage
<span data-jmpress="appear">...</span>
<span data-jmpress="appear after 300ms">================================================================================
- Timings
================================================================================</span>
<span data-jmpress="appear">> scan classpath : < 1 second</span>
<span data-jmpress="appear">> coverage and dependency analysis : <span class="nb">24 minutes and 32 seconds</span></span>
<span data-jmpress="appear">> build mutation tests : 7 seconds</span>
<span data-jmpress="appear">> run mutation analysis : <span class="nb">2 hours, 47 minutes and 3 seconds</span></span>
<span data-jmpress="appear">--------------------------------------------------------------------------------
> Total  : <span class="nb">3 hours, 11 minutes and 44 seconds</span></span></pre>

                <p class="info" data-jmpress="appear">
                    The total mutation coverage is 79%
                </p>

            </div>

            <div class="step spoiler" data-x="5500" data-y="2400" style='text-align: center;'>
                <img src="img/slowpoke.png"/>
            </div>

            <div class="step" data-x="5500" data-y="3200">
                <h2>We could throw in more threads</h2>
                <pre class="mono console"><span class="prompt">commons-math3$</span> mvn clean test pitest:mutationCoverage <span class="nb">-Dpit.threads=24</span>
<span data-jmpress="appear">...</span>
<span data-jmpress="appear after 300ms">================================================================================
- Timings
================================================================================</span>
<span data-jmpress="appear">> scan classpath : < 1 second</span>
<span data-jmpress="appear">> coverage and dependency analysis : <span class="nb">24 minutes and 45 seconds</span></span>
<span data-jmpress="appear">> build mutation tests : 2 seconds</span>
<span data-jmpress="appear">> run mutation analysis : <span class="nb">40 minutes and 39 seconds</span></span>
<span data-jmpress="appear">--------------------------------------------------------------------------------
> Total  : <span class="nb">1 hours, 5 minutes and 28 seconds</span></span></pre>
                <p class="warn" data-jmpress="appear">
                    That doesn't seem to be helping much!
                </p>

            </div>

            <div class="step" data-x="5500" data-y="3200" data-rotate-y="90">
                <h2>Mutation analysis run on Apache commons-math3</h2>
                <img src="img/performance-graph-commons-math3.png"/>
            </div>

            <div class="step" data-x="5500" data-y="4000">
                <h2>But there's the incremental analysis feature</h2>
                <h3 data-jmpress="fade">Metadata is stored between runs</h3>
                <ul>
                    <li data-jmpress="fade">Hashes of all tested source classes</li>
                    <li data-jmpress="fade">Hashes of all run test classes</li>
                    <li data-jmpress="fade">Mutation analysis results</li>
                </ul>
            </div>

            <div class="step" data-x="5500" data-y="4800">
                <h3>During a new run, heuristics are applied <br/>
                A mutation won't be tested again, if it</h3>
                <ul>
                    <li data-jmpress="fade">has <font color="#00008b">timed out</font> the previous time, and the class hasn't changed</li>
                    <li data-jmpress="fade">has been <font color="#008b00">killed</font> the previous time, and neither the class nor the test has changed</li>
                    <li data-jmpress="fade">has <font color="#8b0000">survived</font> the previous time, and no new tests cover it, and the old tests haven't changed</li>
                </ul>
            </div>

            <div class="step" data-x="5500" data-y="5600">
                <h3>Wait, what about dependencies?</h3>
                <p data-jmpress="fade">
                    PIT only takes into account the changes made to super classes and outer classes, but not usages
                    of classes by other classes.
                </p>
            </div>

            <div class="step" data-x="5500" data-y="6400">
                <h2>Let's see how it fares</h2>
                <pre class="mono console"><span class="prompt">commons-math3$</span> mvn clean test pitest:mutationCoverage <span class="nb">-P pit-history</span> -Dpit.threads=24

<span data-jmpress="fade">...
================================================================================
- Timings
================================================================================
> scan classpath : < 1 second
> coverage and dependency analysis : <span class="nb">22 minutes and 36 seconds</span>
> build mutation tests : 2 seconds
> run mutation analysis : <span class="nb">46 minutes and 29 seconds</span>
--------------------------------------------------------------------------------
> Total  : <span class="nb">1 hours, 9 minutes and 8 seconds</span></span></pre>

                <p class="info" data-jmpress="fade">
                    Nearly no overhead on saving history metadata
                </p>
            </div>

            <div class="step" data-x="5500" data-y="7200" data-rotate-y="90">
                <h2>Whoa! PIT has found some useless code!</h2>
                <table>
                    <tr>
                        <td class="line-numbers"><pre class="mono">


193
194
<span class="fc">195
196
197
198
199</span>
<span class="nc" data-jmpress="become-green">200</span>
<span class="fc">201
202
203</span>
<span data-jmpress="disappear after 1ms">204</span></pre></td>
                        <td><pre class="mono prettyprint lang-java">// In org.apache.commons.math3.linear.MatrixUtils

public static &lt;T extends FieldElement&lt;T&gt;&gt; FieldMatrix&lt;T&gt;
createFieldIdentityMatrix(final Field&lt;T&gt; field, final int dimension) {
<span class="fc">    final T zero = field.getZero();
    final T one  = field.getOne();
    final T[][] d = MathArrays.buildArray(field, dimension, dimension);
    for (int row = 0; row < dimension; row++) {
        final T[] dRow = d[row];</span><span class="nc" data-jmpress="disappear after 1ms">
        Arrays.fill(dRow, zero);</span>
<span class="fc">        dRow[row] = one;
    }
    return new Array2DRowFieldMatrix&lt;T&gt;(field, d, false);</span>
}</pre></td>
                    </tr>
                </table>
                <h3>Mutations</h3>
                <ol class="mutation-list mono">
                    <li class="nc">200: removed call to java/util/Arrays::fill : SURVIVED</li>
                </ol>
            </div>

            <div class="step" data-x="5500" data-y="7200" data-rotate-y="90" data-z="-1100">
                <h2>Run the tests again</h2>
                <pre class="mono console"><span class="prompt">commons-math3$</span> mvn clean test pitest:mutationCoverage <span class="nb">-P pit-history</span> -Dpit.threads=24

<span data-jmpress="fade">...
================================================================================
- Timings
================================================================================
> scan classpath : < 1 second</span>
<span data-jmpress="fade">> coverage and dependency analysis : <span class="nb">22 minutes and 39 seconds</span>
> build mutation tests : 1 minutes and 40 seconds</span>
<span data-jmpress="fade">> run mutation analysis : <span class="nb">42 seconds</span></span>
<span data-jmpress="fade">--------------------------------------------------------------------------------
> Total  : <span class="nb">25 minutes and 2 seconds</span>
--------------------------------------------------------------------------------</span></pre>
            </div>


            <!--
            ***********************************
                      SUCCESS STORIES
            ***********************************
            -->

            <div class="step" data-x="6600">
                <h2>Why would I want to use PIT?</h2>
                <p>
                    The three laws of Test Driven Development<sup>[3]</sup><br/>
                    <span data-jmpress="fade">You are not allowed to write</span>
                    <ul>
                        <li data-jmpress="fade after 1ms">any production code unless it is to make a failing unit test pass</li>
                        <li data-jmpress="fade">any more of a unit test than is sufficient to fail; and compilation failures are failures</li>
                        <li data-jmpress="fade">any more production code than is sufficient to pass the one failing unit test</li>
                    </ul>
                </p>
            </div>

            <div class="step" data-x="6600" data-y=800>
                <h2>PIT gives you <span class="success">confidence</span> in your tests</h2>
                <p data-jmpress="fade">
                    Success story from TheLadders.com<sup>[4]</sup>
                    <ul>
                        <li data-jmpress="fade">Project from scratch, mutation analysis from the very beginning</li>
                        <li data-jmpress="fade">Code and Mutation Coverage of <span class="success">95%</span></li>
                        <li data-jmpress="fade">It has been decided to refactor the db backend to use event sourcing</li>
                        <li data-jmpress="fade">Refactored, had all the tests pass, and encountered no issue afterwards</li>
                    </ul>
                </p>
            </div>

            <div class="step" id="reading-material" data-x="1100" data-y="800">
                <h2>You might want to read</h2>
                <ol>
                    <li>Mutation Analysis [1979]: Budd, Lipton, DeNillo, Sayward<br/>
                        <a href="http://www.cs.yale.edu/publications/techreports/tr155.pdf">
                            http://www.cs.yale.edu/publications/techreports/tr155.pdf
                        </a>
                    </li>
                    <li>
                        Detailed comparison of java mutation testing frameworks<br/>
                        <a href="http://pitest.org/java_mutation_testing_systems">
                            http://pitest.org/java_mutation_testing_systems
                        </a>
                    </li>
                    <li>
                        The three laws of TDD <br/>
                        <a href="http://butunclebob.com/ArticleS.UncleBob.TheThreeRulesOfTdd">
                            http://butunclebob.com/ArticleS.UncleBob.TheThreeRulesOfTdd
                        </a>
                    </li>
                    <li>
                        Mutation Testing With PIT: A Step Beyond Normal Code Coverage<br/>
                        <a href="http://dev.theladders.com/2013/02/mutation-testing-with-pit-a-step-beyond-normal-code-coverage/">
                            http://dev.theladders.com/2013/02/mutation-testing-with-pit-a-step-beyond-normal-code-coverage/
                        </a>
                    </li>
                </ol>
            </div>

            <div class="step" id="try-me" data-x="1100" data-y="1600">
                <h2>To reproduce everything you saw here</h2>
                <pre class="console mono">$ git clone git@github.com:gvsmirnov/docs.git
$ cd docs/presentations/java-mutation-testing</pre>
                <h2>To view this presentation again</h2>
                <p><a href="http://gvsmirnov.ru/docs/presentations/java-mutation-testing/">http://gvsmirnov.ru/docs/presentations/java-mutation-testing/</a><br/>
                    <small class="remark">Known to work in Yandex.Browser and Google Chrome on Mac OS X</small>
                </p>
            </div>

            <div id="overview" class="step" data-x="3000" data-y="1500" data-scale="10"></div>
        </div>

        <script type="text/javascript">
            $(function() {
                    $('#impress').jmpress({
                        "mouse": { clickSelects: false },
                        "beforeChange": function(element, eventData) {
                            element = $(element);
                            if(element.is('tr')) {
                                element.addClass('visited'); // code should not be hidden after visiting
                            }
                        }
                    });
            });

            prettyPrint();
        </script>
    </body>
</html>




