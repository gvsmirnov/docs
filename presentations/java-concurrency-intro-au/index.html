<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Java concurrency: why & how</title>
        <link href="impress.css" rel="stylesheet"/>
        <script src="jquery-1.8.2.min.js"></script>
        <script src="jmpress.impress.js"></script>
    </head>

    <body>
        <div id="impress" class="impress-not-supported">
            <div class="step slide" style="text-align: center">
                <h1>Куда текут абстракции многопоточности</h1>
                <h2>Или казалось бы, причём здесь Java</h2>
            </div>

            <div class="step slide" data-x="1100">
                <h1>Disclaimer: <small style="font-size: 30px">на самом деле, всё не так</small></h2>
                <p>
                    Изложенный на данном семинаре материал является общим и поверхностным описанием того, как и почему работает многопоточность.
                    Во многих реальных случаях происходящее может отличаться от описанного здесь. Многие из теоретических аспектов также опущены или упрощены.
                </p>
            </div>

            <div class="step" data-x="2200" data-y="-800">
                <h2>Just another brick in the <strong>memory wall</strong></h2>
                <ul>
                    <li>Скорость доступа к RAM растёт в ~1000 раз медленнее, чем скорость CPU</li>
                    <li>Нужно расположить данные ближе к ядрам! Многоуровневые кеши &dash; панацея!</li>
                </ul>
            </div>

            <div class="step" data-x="2200">
                <h1>Moore's law</h1>
                <p>Число транзисторов, умещающихся на интегральной схеме, удваивается каждые два года</p>
            </div>

            <div class="step" data-x="2200" data-y="800">
                <img width="700" src="img/moore-graph.png" />
            </div>

            <div class="step" data-x="3300">
                <h1>Частота процессоров почти не растёт</h1>
                <p>
                    За последние 5-10 лет практически не увеличилась частота процессора, поскольку возникли физические ограничения.
                </p>
            </div>

            <div class="step" data-x="3300" data-y="800" data-jmpress="fade">
                <h2>Частота vs размер</h2>
                <p>
                    <ul>
                        <li>transistor gate и так толщиной в молекулу</li>
                        <li>Провода, соединяющие транзисторы, становятся тоньше =&gt; больше сопротивление</li>
                    </ul>
                </p>
            </div>

            <div class="step" data-x="3300" data-y="1600">
                <h2>Частота vs энергоэффективность</h2>
                <p>
                    <ul>
                        <li><strong>clock-gating</strong>: если новое состояние такое же, как и старое, смена не производится</li>
                        <li><strong>power-gating</strong>: неиспользуемые функциональные блоки отключаются</li>
                    </ul>
                </p>
            </div>

            <div class="step" data-y="1000" data-x="1100" data-rotate="90">
                <img src="img/boromir-on-cpus.jpg" />
            </div>

            <div class="step nested-steps" data-y="1900" data-x="1100" data-scale="3" id="mottos" data-duration="10">
                <span class="step" data-x="-100" data-y="-160" data-rotate="-20" data-scale="0.6">Параллельные алгоритмы в массы!</span>
                <span class="step" data-x="200" data-y="-10" data-rotate="10" data-scale="0.8">Нужно больше блоков исполнения!</span>
                <span class="step" data-x="10" data-y="20" data-scale="0.8">Даёшь больше нативных потоков!</span>
                <span class="step" data-x="300" data-y="200" data-rotate="30" data-scale="0.7">Не допустим простоя процессора!</span>
                <span class="step" data-x="-250" data-y="100" data-rotate="-10" data-scale="0.5">Нужно использовать модель акторов!</span>
            </div>

            <div class="step" data-x="4400">
                <h1>Cache coherency</h1>
                <p>
                    &laquo;А что, если у потоков есть общая память?&raquo;
                </p>
            </div>

            <div class="step" data-x="4400" data-y="800">
                <h2>Протокол <strong class="mono">MESI</strong></h2>
                <ul>
                    <li><span class="mono"><strong class="large">I</strong>nvalid</span> &dash; ячейка не содержится в кеше;</li>
                    <li><span class="mono"><strong class="large">S</strong>hared</span> &dash; ячейка содердится в кеше, но не только у этого ядра;</li>
                    <li><span class="mono"><strong class="large">E</strong>xclusive</span> &dash; ячейка содердится в кеше только у этого ядра;</li>
                    <li><span class="mono"><strong class="large">M</strong>odified</span> &dash; значение в кеше изменено, но об этом пока никто не знает</li>
                </ul>
            </div>

            <div class="step" data-x="4400" data-y="1600">
                <h2>Сообщения протокола <strong class="mono">MESI</strong></h2>
                <ul>
                    <li><span class="mono"><strong>Read</strong> &amp; <strong>Read Response</strong></span> &dash; чтение ячейки и ответ на этот запрос;</li>
                    <li><span class="mono"><strong>Invalidate</strong> &amp; <strong>Invalidate Acknowledge</strong></span> &dash; команда удалить ячейку из кеша и ответ на этот запрос;</li>
                    <li><span class="mono"><strong>Read Invalidate</strong></span> &dash; запрос значения ячейки с требованием еэ сразу же удалить;</li>
                    <li><span class="mono"><strong>Writeback</strong></span> &dash; записать ячейку в основную память</li>
                </ul>
            </div>

            <div class="step" data-x="4400" data-y="2400">
                <h2>Store Buffers</h2>
                <p>
                    Не дожидаясь <strong class="mono">Invalidate Acknowledge</strong>, поместить новое значение в буфер и продолжить выполнять инструкции.
                    Когда придут все <strong class="mono">acknowledge</strong>, произвести запись.
                </p>
            </div>

            <div class="step nested-steps listing" data-x="4400" data-y="3200">
                <table>
                    <tr>
                        <td style="width: 450px;"><strong class="mono">CPU 0</strong></td>
                        <td><strong class="mono">CPU 1</strong></td>
                    </tr>
                    <tr>
                        <td>
                            <pre>
value <span style='color:#808030; '>=</span> <span style='color:#008c00; '>10</span><span style='color:#800080; '>;</span>
finished <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>true</span><span style='color:#800080; '>;</span></pre>
                        </td>
                        <td>
                            <pre>
<span style='color:#800000; font-weight:bold; '>while</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>finished<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<b>assert</b> value <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>10</span><span style='color:#800080; '>;</span></pre>
                        </td>
                    </tr>
                    <tr class="step" data-y="100">
                        <td colspan="2">
                            Казалось бы, что может пойти не так?
                        </td>
                    </tr>
                    <tr class="step" data-y="200">
                        <td style="width: 450px;">
                            <pre>finished: <strong>E</strong>
value: <strong>I</strong></pre>
                        </td>
                        <td>
                            <pre>finished: <strong>I</strong>
value: <strong>E</strong></pre>
                        </td>
                    </tr>
                    <tr class="step" data-y="300">
                        <td style="width: 450px;">
                            <pre>&gt; value <span style='color:#808030; '>=</span> <span style='color:#008c00; '>10</span><span style='color:#800080; '>;</span>
&lt; store_buffer(<strong>value</strong>)
&lt; read_inv(<strong>value</strong>)</pre>
                        </td>
                        <td valign="top">
                            <pre>&gt; <span style='color:#800000; font-weight:bold; '>while</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>finished<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
&lt; read(<strong>finished</strong>)</pre>
                        </td>
                    </tr>
                    <tr class="step" data-y="450">
                        <td style="width: 450px;">
                            <pre>&gt; finished <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>true</span><span style='color:#800080; '>;</span>
finished: <strong>M</strong>
&lt; read_resp(<strong>finished</strong>)
finished: <strong>S</strong></pre>
                        </td>
                        <td valign="top">
                            <pre>



finished: <strong>S</strong></pre>
                        </td>
                    </tr>
                    <tr class="step" data-y="600">
                        <td style="width: 450px;">
                        </td>
                        <td valign="top">
                            <pre>&gt; <b>assert</b> value <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>10</span><span style='color:#800080; '>;</span></pre>
                        </td>
                    </tr>
                    <tr class="step" data-y="800">
                        <td colspan="2">
                            <center><h1 style="color: darkred">Assertion FAILS!</h1></center>
                        </td>
                    </tr>
                    <tr class="step" data-y="1000">
                        <td style="width: 450px;">
                        </td>
                        <td valign="top">
                            <pre>&lt; read_resp(<strong>value</strong>)
&lt; invalidate_ack(<strong>value</strong>)
value: <strong>I</strong>
                            </pre>
                        </td>
                    </tr>
                    <tr class="step" data-y="1100">
                        <td style="width: 450px;">
                            <pre>&lt; writeback(<strong>value</strong>)</pre>
                        </td>
                        <td></td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="5500" data-y="2400">
                <h2>Invalidate queues</h2>
                <p>
                    <strong class="mono">Invalidate Acknowledge</strong> будет отправлен моментально, а фактически инвалидацию процессор сделает тогда, когда
                    ему это будет удобно. При этом до того, как он это сделает, не будет отправлено ни одно сообщение по соответствующей ячейке памяти.
                </p>
            </div>

            <div class="step nested-steps listing" data-x="5500" data-y="3200">
                <table>
                    <tr>
                        <td style="width: 450px;"><strong class="mono">CPU 0</strong></td>
                        <td><strong class="mono">CPU 1</strong></td>
                    </tr>
                    <tr>
                        <td>
                            <pre>
value <span style='color:#808030; '>=</span> <span style='color:#008c00; '>10</span><span style='color:#800080; '>;</span>
finished <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>true</span><span style='color:#800080; '>;</span></pre>
                        </td>
                        <td>
                            <pre>
<span style='color:#800000; font-weight:bold; '>while</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>finished<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<b>assert</b> value <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>10</span><span style='color:#800080; '>;</span></pre>
                        </td>
                    </tr>
                    <tr class="step" data-y="100">
                        <td colspan="2">
                            Казалось бы, что <strong>ещё</strong> может пойти не так?
                        </td>
                    </tr>
                    <tr class="step" data-y="200">
                        <td style="width: 450px;">
                            <pre>finished: <strong>E</strong>
value: <strong>S</strong></pre>
                        </td>
                        <td>
                            <pre>finished: <strong>I</strong>
value: <strong>S</strong></pre>
                        </td>
                    </tr>
                    <tr class="step" data-y="300">
                        <td style="width: 450px;">
                            <pre>&gt; value <span style='color:#808030; '>=</span> <span style='color:#008c00; '>10</span><span style='color:#800080; '>;</span>
&lt; store_buffer(<strong>value</strong>)
&lt; invalidate(<strong>value</strong>)</pre>
                        </td>
                        <td valign="top">
                            <pre>&gt; <span style='color:#800000; font-weight:bold; '>while</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>finished<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
&lt; read(<strong>finished</strong>)</pre>
                        </td>
                    </tr>
                    <tr class="step" data-y="450">
                        <td style="width: 450px;">
                            <pre>&gt; finished <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>true</span><span style='color:#800080; '>;</span>
finished: <strong>M</strong>
&lt; read_resp(<strong>finished</strong>)
finished: <strong>S</strong></pre>
                        </td>
                        <td valign="top">
                            <pre>invalidate_ack(<strong>value</strong>)
invalidate_queue(<strong>value</strong>)

finished: <strong>S</strong></pre>
                        </td>
                    </tr>
                    <tr class="step" data-y="600">
                        <td style="width: 450px;">
                        </td>
                        <td valign="top">
                            <pre>&gt; <b>assert</b> value <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>10</span><span style='color:#800080; '>;</span></pre>
                        </td>
                    </tr>
                    <tr class="step" data-y="800">
                        <td colspan="2">
                            <center><h1 style="color: darkred">Assertion fails AGAIN!</h1></center>
                        </td>
                    </tr>
                    <tr class="step" data-y="1000">
                        <td style="width: 450px;">
                            <pre>&lt; writeback(<strong>value</strong>)</pre>
                        </td>
                        <td valign="top">
                            <pre>value: <strong>I</strong></pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="5500" data-rotate="270">
                <h1>Trade-off</h1>
                <p>
                    <strong>Performance</strong> vs <strong>"free" coherence</strong>
                </p>
                <p>
                    Есть грань между производительностью и "простотой" написания многопоточного приложения
                </p>
            </div>

            <div class="step" data-x="6300" data-rotate="270">
                <h1>Memory Model</h1>
                <p>
                    Описание того, как потоки взаимодействуют с памятью в некоторой среде исполнения. Позволяет "автору" кода (разработчику, компилятору, ...)
                    понять, как их код всё же будет выполнен.
                </p>
            </div>

            <div class="step" data-x="7100" data-rotate="270">
                <h1>Memory Barrier</h1>
                <p>
                    Инструкция для процессора, запрещающая допускать <strong>reordering</strong> инструкций чтения и/или записи. В простейшем случае различают <strong>Store Memory Barrier</strong>, <strong>Load Memory Barrier</strong>, <strong>Fence</strong>
                </p>
            </div>

            <div class="step" data-x="8000" data-rotate="270">
                <h1>Store Memory Barrier</h1>
                <p>
                    Требование у процессора выполнить все <strong>store</strong>, уже находящиеся в буфере, прежде чем выполнять те, что попадут туда после этой инструкции
                </p>
            </div>

            <div class="step" data-x="8900" data-rotate="270">
                <h1>Load Memory Barrier</h1>
                <p>
                    Требование у процессора применить все <strong>invalidate</strong>, уже находящиеся в очереди, прежде чем выполнять какие-либо инструкции <strong>load</strong>
                </p>
            </div>

            <div class="step" data-x="9800" data-rotate="270">
                <table>
                    <tr>
                        <td style="width: 450px;"><strong class="mono">CPU 0</strong></td>
                        <td><strong class="mono">CPU 1</strong></td>
                    </tr>
                    <tr>
                        <td>
                            <pre>
value <span style='color:#808030; '>=</span> <span style='color:#008c00; '>10</span><span style='color:#800080; '>;</span>
storeMemoryBarrier();
finished <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>true</span><span style='color:#800080; '>;</span></pre>
                        </td>
                        <td>
                            <pre>
<span style='color:#800000; font-weight:bold; '>while</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>finished<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
loadMemoryBarrier();
<b>assert</b> value <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>10</span><span style='color:#800080; '>;</span></pre>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="step" data-x="10700" data-rotate="270">
                <h1>Membar &dash; инструмент HMM</h1>
                <p>
                    Различных HMM очень много; они варьируются не только от вендора к вендору, но даже и внутри одной линейки одного производителя.
                </p>
            </div>

            <div class="step" data-x="6600" data-y="1600">
                <center>
                    <h1 style="color: #ea2d2e;">Write Once</h1>
                    <img src="img/java-logo.png" />
                    <h1 style="color: #0074bd;">Run Anywhere</h1>
                </center>
            </div>

            <div id="overview" class="step" data-x="3000" data-y="1500" data-scale="10"></div>
        </div>

        <script type="text/javascript">
            $(function() {
                    $('#impress').jmpress({
                        "mouse": { clickSelects: false },
                        "beforeChange": function(element, eventData) {
                            element = $(element);
                            if(element.is('tr')) {
                                element.addClass('visited'); // code should not be hidden after visiting
                            }
                        }
                    });
            });
        </script>
    </body>
</html>




